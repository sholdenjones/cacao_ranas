---
title: "ranas_analysis"
author: "Holden Jones"
date: "2024-10-23"
output: html_document
---

Use this document for analyses and figures to be used in paper

load packages
```{r, include=FALSE}
library(labdsv)
library(tidyverse)
library(vegan)
library(iNEXT)
library(sjmisc)
library(RColorBrewer) # for assigning plot colors
library(lme4)
library(ggpubr) # for arranging multi-panel figures
library(car)
library(glmmTMB)
library(httr)
library(DHARMa)
```

load data
```{r, include=FALSE}
ranas <- read_csv("data/processed_data/ranas_processed.csv")
ranas <- as_tibble(ranas)

new <- read_csv("data/processed_data/new_processed.csv")
new <- as_tibble(new)

new_no_priach <- read_csv("data/processed_data/new_no_priach_processed.csv")
new_no_priach <- as_tibble(new_no_priach)

new_threatened <- read_csv("data/processed_data/new_threatened_processed.csv")
new_threatened <- as_tibble(new_threatened)

### REVIEW THIS SECTION ###
new_mat <- read_csv("data/processed_data/new_mat_processed.csv")
new_mat <- as.matrix(new_mat)

new_mat_test <- read_csv("data/processed_data/new_mat_test_processed.csv")
new_mat_test <- as.matrix(new_mat_test)
### REVIEW THIS SECTION ###

site_data <- read_csv("data/processed_data/site_data_processed.csv")
site_data <- as_tibble(site_data)

site_type <- read_csv("data/processed_data/site_type_processed.csv")
site_type <- as_tibble(site_type)

richness_by_site <- read_csv(
  "data/processed_data/richness_by_site_processed.csv")
richness_by_site <- as_tibble(richness_by_site)

richness_by_site_no_priach <- read_csv(
  "data/processed_data/richness_by_site_no_priach_processed.csv")
richness_by_site_no_priach <- as_tibble(richness_by_site_no_priach)

threatened_richness_by_site <- read_csv(
  "data/processed_data/threatened_richness_by_site_processed.csv")
threatened_richness_by_site <- as_tibble(threatened_richness_by_site)

abundance_by_site <- read_csv(
  "data/processed_data/abundance_by_site_processed.csv")
abundance_by_site <- as_tibble(abundance_by_site)

abundance_by_site_no_priach <- read_csv(
  "data/processed_data/abundance_by_site_no_priach_processed.csv")
abundance_by_site <- as_tibble(abundance_by_site_no_priach)

diversity_by_site <- read_csv(
  "data/processed_data/diversity_by_site_processed.csv")
diversity_by_site <- as_tibble(diversity_by_site)

diversity_by_site_no_priach <- read_csv(
  "data/processed_data/diversity_by_site_no_priach_processed.csv")
diversity_by_site_no_priach <- as_tibble(diversity_by_site_no_priach)

trans_richness_local <- read_csv(
  "data/processed_data/trans_richness_local_processed.csv")
trans_richness_local <- as_tibble(trans_richness_local)

site_richness_local <- read_csv(
  "data/processed_data/site_richness_local_processed.csv")
site_richness_local <- as_tibble(site_richness_local)

priach_by_site <- read_csv(
  "data/processed_data/priach_by_site_processed.csv")
priach_by_site <- as_tibble(priach_by_site)

# matrix files from FVE
data.shade=read.table("data/processed_data/SHADE.txt", head= T)
data.sun=read.table("data/processed_data/SUN.txt", head= T)
data.for=read.table("data/processed_data/FOREST.txt", head= T)
data.aba=read.table("data/processed_data/ABANDON.txt", head= T)
```

define a consistent palet, labels, and theme to be used in figures
```{r, include=FALSE}
# palet for comparisons of all 4 site types
pal <- brewer.pal(4, "BrBG")

# set a theme for ggplots
my_theme <- function() {
  theme_minimal() + 
   theme(legend.position = "none",
        plot.background = element_rect("white"),
        panel.background = element_rect("white"),
        panel.grid = element_line("grey90"),
        axis.line = element_line("gray25"),
        axis.text = element_text(size = 12, color = "gray25"),
        axis.title = element_text(size = 14, color = "gray25"),
        legend.text = element_text(size = 12))
}
```

functions
```{r}
# function for checking model overdispersion
check_overdispersion <- function(model) {
  # Residual deviance and degrees of freedom
  dev <- deviance(model)
  df <- df.residual(model)
  
  # Overdispersion ratio
  ratio <- dev / df
  
  # Test statistic (chi-square distribution)
  p_value <- pchisq(dev, df, lower.tail = FALSE)
  
  # Display the results
  c(Overdispersion = ratio, p_value = p_value)
}
```

#1. Compare abundance, richness and Shannon diversity of shade and sun

##a. richness
- Use two-sample t-test b/c not perfectly paired in landscape and dif number of sites
- If remove VC-N (weird site turned out to be N, not paired), then can run paired t-test
```{r}
# create species richness vector for each cacao type
rich_ccn <- richness_by_site %>%
  filter(Tipo == 'C') %>%
  pull(no_species)
  
rich_n <- richness_by_site %>%
  filter(Tipo == 'N') %>%
  pull(no_species)

# run two-sample t-test for species richness
t.test(rich_ccn, rich_n, paired = FALSE)
```

- Here run paired t-test w/out VC-N
```{r}
# drop VC-N from df, this site messes up pairing for t-test
pair_rich_by_site <- richness_by_site %>%
  filter(Sitio != 'VC-N') %>%
  arrange(Pair) # sort by Pair so vectors pulled align with pairs

# create species richness vector for each cacao type
pair_rich_ccn <- pair_rich_by_site %>%
  filter(Tipo == 'C') %>%
  pull(no_species)
  
pair_rich_n <- pair_rich_by_site %>%
  filter(Tipo == 'N') %>%
  pull(no_species)

t.test(pair_rich_ccn, pair_rich_n, paired = TRUE)
```

Boxplot figure for CCN vs. Nacional species richness
```{r}
# site labels for 2 site comparison
site_labels <-  c("Shade \n (n = 12)", "Sun \n (n = 11)")

# reorder factor levels
richness_by_site$Tipo <- factor(richness_by_site$Tipo,
                         c("N", "C", "V", "B"))

richness_by_site_cacao <- richness_by_site %>%
  filter(Tipo == "C" | Tipo == 'N')

# plot species richness across landuse types using palet, my_theme
plot_richness_by_site_cacao <- ggplot(richness_by_site_cacao, 
                                     aes(x = Tipo, y = no_species, fill = Tipo)) +
  geom_boxplot() +
  scale_fill_manual(values = pal) + # order needs to match factor levels above
  scale_x_discrete(labels = c(site_labels)) +
  my_theme() + 
  labs(x = "Cacao type",
       y = "Species richness")

plot_richness_by_site_cacao
#ggsave("output/plot_richness_by_site_cacao.png", width = 10, height = 10)
```



##b. Shannon diversity
Compare Shannon diversity of CCN and Nacional
- same process as above, can be done with paired or two-sample t-test

two-sample t-test
```{r}
# Two sample t-test for shannon diversity:

# create Shannon diversity vector for each cacao type
shannon_ccn <- diversity_by_site %>%
  filter(Tipo == 'C') %>%
  pull(Shannon_Index)
  
shannon_n <- diversity_by_site %>%
  filter(Tipo == 'N') %>%
  pull(Shannon_Index)

# run two-sample t-test for shannon diversity
t.test(shannon_ccn, shannon_n, paired = FALSE)
```

paired t-test
```{r}
# Paired t-test for Shannon diversity 

# drop VC-N from df, this site messes up pairing for t-test
pair_diversity_by_site <- diversity_by_site %>%
  filter(Sitio != 'VC-N') %>%
  arrange(Pair) # sort by Pair so vectors pulled align with pairs

# create Shannon diversity vector for each cacao type
pair_shannon_ccn <- pair_diversity_by_site %>%
  filter(Tipo == 'C') %>%
  pull(Shannon_Index)
  
pair_shannon_n <- pair_diversity_by_site %>%
  filter(Tipo == 'N') %>%
  pull(Shannon_Index)

t.test(pair_shannon_ccn, pair_shannon_n, paired = TRUE)
```

Boxplot figure for CCN vs. Nacional Shannon diversity
```{r}
# reorder factor levels
diversity_by_site$Tipo <- factor(diversity_by_site$Tipo,
                         c("N", "C", "V", "B"))

shannon_by_site_cacao <- diversity_by_site %>%
  filter(Tipo == "C" | Tipo == 'N')

# plot Shannon diversity across landuse types using palet, my_theme
plot_shannon_by_site_cacao <- ggplot(shannon_by_site_cacao, 
                                     aes(x = Tipo, y = Shannon_Index, fill = Tipo)) +
  geom_boxplot() +
  scale_fill_manual(values = pal) + # order needs to match factor levels above
  scale_x_discrete(labels = c(site_labels)) +
  my_theme() + 
  labs(x = "Cacao type",
       y = "Shannon diversity")

plot_shannon_by_site_cacao
#ggsave("output/plot_shannon_by_site_cacao.png", width = 10, height = 10)
```



##c. abundance
Same process as above - use abundance_by_site for two sample t-test
```{r}
# create species abundance vector for each cacao type
abun_ccn <- abundance_by_site %>%
  filter(Tipo == 'C') %>%
  pull(n)
  
abun_n <- abundance_by_site %>%
  filter(Tipo == 'N') %>%
  pull(n)

# run two-sample t-test for species richness
t.test(abun_ccn, abun_n, paired = FALSE)
```

paired t-test
```{r}
# drop VC-N from df, this site messes up pairing for t-test
pair_abundance_by_site <- abundance_by_site %>%
  filter(Sitio != 'VC-N') %>%
  arrange(Pair) # sort by Pair so vectors pulled align with pairs

# create abundance vector for each cacao type
pair_abun_ccn <- pair_abundance_by_site %>%
  filter(Tipo == 'C') %>%
  pull(n)
  
pair_abun_n <- pair_abundance_by_site %>%
  filter(Tipo == 'N') %>%
  pull(n)

t.test(pair_abun_ccn, pair_abun_n, paired = TRUE)
```

Boxplot figure for CCN vs. Nacional abundance
```{r}
# site labels for 2 site comparison
site_labels <-  c("Shade \n (n = 12)", "Sun \n (n = 11)")

# reorder factor levels
abundance_by_site$Tipo <- factor(abundance_by_site$Tipo,
                         c("N", "C", "V", "B"))

abundance_by_site_cacao <- abundance_by_site %>%
  filter(Tipo == "C" | Tipo == 'N')

# plot species richness across landuse types using palet, my_theme
plot_abundance_by_site_cacao <- ggplot(abundance_by_site_cacao, 
                                     aes(x = Tipo, y = n, fill = Tipo)) +
  geom_boxplot() +
  scale_fill_manual(values = pal) + # order needs to match factor levels above
  scale_x_discrete(labels = c(site_labels)) +
  my_theme() + 
  labs(x = "Cacao type",
       y = "Amphibian abundance")

plot_abundance_by_site_cacao
#ggsave("output/plot_abundance_by_site_cacao.png", width = 10, height = 10)
```




#2.Compare abundance, richness and Shannon diversity of forest and abandoned plantations

##a. richness
- Use two-sample t-test b/c not paired and dif number of sites
```{r}
# create species richness vector for each cacao type
rich_forest <- richness_by_site %>%
  filter(Tipo == 'B') %>%
  pull(no_species)
  
rich_abandon <- richness_by_site %>%
  filter(Tipo == 'V') %>%
  pull(no_species)

# run two-sample t-test for species richness
t.test(rich_forest, rich_abandon, paired = FALSE)
```

Boxplot figure for forest vs. abandoned species richness
```{r}
site_labels <- c("Abandoned \n (n = 4)", "Forest \n (n = 5)")

# reorder factor levels
richness_by_site$Tipo <- factor(richness_by_site$Tipo,
                         c("N", "C", "V", "B"))

richness_by_site_inactive <- richness_by_site %>%
  filter(Tipo == "B" | Tipo == 'V')

# plot species richness across landuse types using palet, my_theme
plot_richness_by_site_inactive <- ggplot(richness_by_site_inactive, 
                                     aes(x = Tipo, y = no_species, 
                                         fill = Tipo)) +
  geom_boxplot() +
  scale_fill_manual(values = c("#80CDC1", "#018571")) +
  scale_x_discrete(labels = c(site_labels)) +
  my_theme() + 
  labs(x = "Reference type",
       y = "Species richness")

plot_richness_by_site_inactive
#ggsave("output/plot_richness_by_site_inactive.png", width = 10, height = 10)
```


##b. Shannon diversity
Compare Shannon diversity of abandoned plantations and remnant forest

two-sample t-test
```{r}
# Two sample t-test for shannon diversity:

# create Shannon diversity vector for each type
shannon_abandon <- diversity_by_site %>%
  filter(Tipo == 'V') %>%
  pull(Shannon_Index)
  
shannon_forest <- diversity_by_site %>%
  filter(Tipo == 'B') %>%
  pull(Shannon_Index)

# run two-sample t-test for shannon diversity
t.test(shannon_abandon, shannon_forest, paired = FALSE)
```

Boxplot figure for abandoned vs. forest Shannon diversity
```{r}
# reorder factor levels
diversity_by_site$Tipo <- factor(diversity_by_site$Tipo,
                         c("N", "C", "V", "B"))

shannon_by_site_inactive <- diversity_by_site %>%
  filter(Tipo == "V" | Tipo == 'B')

# plot Shannon diversity across landuse types using palet, my_theme
plot_shannon_by_site_inactive <- ggplot(shannon_by_site_inactive, 
                                     aes(x = Tipo, y = Shannon_Index, 
                                         fill = Tipo)) +
  geom_boxplot() +
  scale_fill_manual(values = c("#80CDC1", "#018571")) +
  scale_x_discrete(labels = c(site_labels)) +
  my_theme() + 
  labs(x = "Reference type",
       y = "Shannon diversity")

plot_shannon_by_site_inactive
#ggsave("output/plot_shannon_by_site_inactive.png", width = 10, height = 10)
```


##c. abundance
Same process as above - use abundance_by_site for two sample t-test
```{r}
# create species abundance vector for each cacao type
abun_abandon <- abundance_by_site %>%
  filter(Tipo == 'V') %>%
  pull(n)
  
abun_forest <- abundance_by_site %>%
  filter(Tipo == 'B') %>%
  pull(n)

# run two-sample t-test for species richness
t.test(abun_abandon, abun_forest, paired = FALSE)
```

Boxplot figure for forest vs. abandoned abundance
```{r}
# reorder factor levels
abundance_by_site$Tipo <- factor(abundance_by_site$Tipo,
                         c("N", "C", "V", "B"))

abundance_by_site_inactive <- abundance_by_site %>%
  filter(Tipo == "V" | Tipo == 'B')

# plot Shannon diversity across landuse types using palet, my_theme
plot_abundance_by_site_inactive <- ggplot(abundance_by_site_inactive, 
                                     aes(x = Tipo, y = n, 
                                         fill = Tipo)) +
  geom_boxplot() +
  scale_fill_manual(values = c("#80CDC1", "#018571")) +
  scale_x_discrete(labels = c(site_labels)) +
  my_theme() + 
  labs(x = "Reference type",
       y = "Amphibian abundance")

plot_abundance_by_site_inactive
#ggsave("output/plot_abundance_by_site_inactive.png", width = 10, height = 10)
```





#3. Arrange figures for publication
arrange these four or six figures as panels in one window
```{r}
# richness and shannon diversity
compare_rich_shannon <- ggarrange(
  plot_richness_by_site_cacao + rremove("xlab"), 
  plot_richness_by_site_inactive + rremove("xlab") + rremove("ylab"),
  plot_shannon_by_site_cacao,
  plot_shannon_by_site_inactive + rremove("ylab"),
  labels = c("A", "B", "C", "D"),
  ncol = 2, nrow = 2,
  label.x = 0.01, 
  label.y = 0.08 
)

compare_rich_shannon
#ggsave("output/compare_rich_shannon.png", width = 10, height = 10)

# abundance, richness and shannon diversity
compare_abun_rich_shannon <- ggarrange(
  plot_abundance_by_site_cacao + rremove("xlab"), 
  plot_abundance_by_site_inactive + rremove("xlab") + rremove("ylab"),
  plot_richness_by_site_cacao + rremove("xlab"), 
  plot_richness_by_site_inactive + rremove("xlab") + rremove("ylab"),
  plot_shannon_by_site_cacao,
  plot_shannon_by_site_inactive + rremove("ylab"),
  labels = c("A", "B", "C", "D", "E", "F"),
  ncol = 2, nrow = 3,
  label.x = 0.01, 
  label.y = 0.13 
)

compare_abun_rich_shannon
#ggsave("output/compare_abun_rich_shannon.png", width = 10, height = 10)
```




#4. Contextualize cacao sites against reference sites

To do this, need to use estimates of asymptotic species richness 
- b/c these sites did not have even sample coverage

## iNEXT to show what the sampling coverage is for each site
- then compare sampling coverage!
- then graphically display this

## ALSO CAN LOOK AT q=1


## THIS CODE DOES NOT WORK ###
## ILLOGICAL OUTPUT ##


# code from Tamara
```{r}
# make vectors for each of the four site types from new_mat
shade <- as.numeric(new_mat[1:12,]) # row numbers for shade
sun <- as.numeric(new_mat[13:23,])
abandoned <- as.numeric(new_mat[24:27,])
forest <- as.numeric(new_mat[28:32,])

type_list <- list(shade,sun,abandoned,forest)
names(type_list) <- c("shade", "sun", "abandoned", "forest")
str(type_list)

out10 <- iNEXT(type_list, q = 0, datatype = "abundance", endpoint = 22000)

#plot sample-size-based rarefaction/extrapolation curve
ggiNEXT(out10, type = 1, grey = FALSE) +
  labs(y = "Species richness", x = "Number of individuals") +
  scale_color_manual(values = c("#80CDC1", "#018571", "#A6611A", "#DFC27D"))

#plot sample-coverage-based rarefaction/extrapolation curve
ggiNEXT(out10, type = 2, grey = FALSE) +
  scale_color_manual(values = c("#80CDC1", "#018571", "#A6611A", "#DFC27D"))

#plot sample completeness curve
ggiNEXT(out10, type = 3, grey = FALSE) +
  labs(y = "Species richness", x = "Sample coverage") +
  scale_color_manual(values = c("#80CDC1", "#018571", "#A6611A", "#DFC27D"))
```



# iNEXT code from Francisco

## none of this makes any sense
```{r}
#####List with matrices all#####
# library(iNEXT)
# library(ggplot2)
# library(devtools)
# library(httr)
# library(grid)

####SHADE

head(data.shade)

#Convert the data frame into a list matrix for inext 
SH <- as.matrix(apply(data.shade[,-1],2, as.integer))

#Name as row names
row.names(SH) <- data.shade[,1]

####SUNNY

head(data.sun)

#Convert the data frame into a list matrix for inext 
SU <- as.matrix(apply(data.sun[,-1],2, as.integer))

#Name as row names
row.names(SU) <- data.sun[,1]


####ABANDON

head(data.aba)

#Convert the data frame into a list matrix for inext 
AB <- as.matrix(apply(data.aba[,-1],2, as.integer))

#Name as row names
row.names(AB) <- data.aba[,1]


####FOREST

head(data.for)

#Convert the data frame into a list matrix for inext 
FO <- as.matrix(apply(data.for[,-1],2, as.integer))

#Name as row names
row.names(FO) <- data.for[,1]


####List of matrices 

# holden.diver = list(SHADE = SH, SUN = SU, ABANDON = AB, FOREST = FO)
# 
# m <- c(10, 20, 30, 40, 50, 60, 100)
# 
# out1 <- iNEXT(holden.diver, datatype = "abundance") 
# 
# fig.alpha1 = ggiNEXT(out1, type =1)+ 
# 
# #Figures 
# 
# #FigDivAlpha = ggiNEXT(out.inc, type = 1, color.var <- "Order.q", z <- fortify(out.inc), 
# # z$col <- z$shape <- factor(z$Order.q)) Revisar 
# par(mfrow=c(2,3))
# 
# #figures species diversity 
# fig1 <- plot(out.incranas, col= "Blue")
# fig1
# #figures sample coverage  
# fig2 <-plot(out.incranas, type = 2, col= "Blue")
# fig2
# #figures species diversity against sample coverage   
# fig3 <-plot(out.incranas, type = 3, col= "Blue")
# fig3




# Load necessary libraries
# library(iNEXT)
# library(ggplot2)

# # SHADE data
# data.shade <- (SHADE)
# SH <- as.matrix(apply(data.shade[,-1], 2, as.integer))
# row.names(SH) <- data.shade[,1]
# 
# # SUN data
# data.sun <- (SUN)
# SU <- as.matrix(apply(data.sun[,-1], 2, as.integer))
# row.names(SU) <- data.sun[,1]
# 
# # ABANDON data
# data.aba <- (ABANDON)
# AB <- as.matrix(apply(data.aba[,-1], 2, as.integer))
# row.names(AB) <- data.aba[,1]

# FOREST data - use existing data if file is not available
# (assuming you've already created the data frame `FOREST`)
# data.for <- FOREST 
# FO <- as.matrix(apply(data.for[,-1], 2, as.integer))
# row.names(FO) <- data.for[,1]

# List of matrices
holden.diver <- list(SHADE = SH, SUN = SU, ABANDON = AB, FOREST = FO)



### lots of issues below here - illogical output from iNEXT ###


# Perform iNEXT analysis (correct the spelling of "abundance_raw")

# out3 <- iNEXT(holden.diver, q=0, datatype = "abundance")
# ggiNEXT(out3)
# par(mfrow=c(2,3))
# 
# #figures species diversity 
# fig1 <- plot(out3)
# fig1
# #figures sample coverage  
# fig2 <-plot(out3, type = 2)
# fig2
# #figures species diversity against sample coverage   
# fig3 <-plot(out3, type = 3)
# fig3
# 
# iNEXT(holden.diver)
# 
# holden.divers <- iNEXT(list(SHADE = SH, SUN = SU, ABANDON = AB, FOREST = FO), datatype = "abundance")
# outfinal <- holden.divers

# # Data information (basic data info)
# data_info <- holden.divers$DataInfo
# print(data_info)
# 
# # Diversity estimates
# diversity_estimates <- holden.divers$iNextEst$size_based
# print(diversity_estimates)
# 
# ggiNEXT(outfinal)
# 
# par(mfrow=c(2,3))
# 
# 
# fig1 <- plot(outfinal)
# fig1
# #figures sample coverage  
# fig2 <-plot(outfinal, type = 2)
# fig2
# #figures species diversity against sample coverage   
# fig3 <-plot(outfinal, type = 3)
# fig3

#########

# data_info <- holden.diver$DataInfo
# print(data_info)
# 
# str(holden.diver)


# 
# # Calculate the number of non-zero species in each assemblage
# shade_obs <- sum(colSums(SH) > 0)
# sun_obs <- sum(colSums(SU) > 0)
# abandon_obs <- sum(colSums(AB) > 0)
# forest_obs <- sum(colSums(FO) > 0)
# 
# print(paste("SHADE observed species:", shade_obs))
# print(paste("SUN observed species:", sun_obs))
# print(paste("ABANDON observed species:", abandon_obs))
# print(paste("FOREST observed species:", forest_obs))
# 
# 
# # Run iNEXT with q=1 or q=2 to reduce bias from rare species
# outfinal_q1 <- iNEXT(list(SHADE = SH, SUN = SU, ABANDON = AB, FOREST = FO), q=1, datatype="abundance")
# outfinal_q2 <- iNEXT(list(SHADE = SH, SUN = SU, ABANDON = AB, FOREST = FO), q=2, datatype="abundance")
# 
# # Inspect the results
# print(outfinal_q1)
# print(outfinal_q2)
# 
# 
# 
# 
# # Plotting Shannon diversity (q=1)
# 
# p1 <- ggiNEXT(outfinal_q1, type=1) + 
#   ggtitle("Shannon Diversity (q = 1)") +
#   theme_minimal()
# 
# # Plotting Simpson diversity (q=2)
# p2 <- ggiNEXT(outfinal_q2, type=1) + 
#   ggtitle("Simpson Diversity (q = 2)") +
#   theme_minimal()
# 
# # Display both plots
# p1
# p2
# 
# 
# 
# 
# 
# 
# out10 <- iNEXT(holden.diver, q=0, datatype = "abundance",endpoint = 22000)
# 
# out10 
# ggiNEXT(out10, type=1,grey=TRUE)+
#   labs(y="Species richness", x="No. of individuals")+
#   labs(tag = "b)") +
#   theme(plot.tag.position = c(0.01, 1))
# 
# out4 <- iNEXT(holden.diver, type = 1, color.var <- "Order.q", z <- fortify(holden.diver), 
#                             z$col <- z$shape <- factor(z$Order.q))
# out4
#               
# # Plot the output
# ggiNEXT(out3)
# 
# par(mfrow=c(2,3))
# 
# #figures species diversity 
# fig1 <- plot(out3, col= "Blue")
# fig1
# #figures sample coverage  
# fig2 <-plot(out3, type = 2, col= "Blue")
# fig2
# #figures species diversity against sample coverage   
# fig3 <-plot(out3, type = 3, col= "Blue")
# fig3
```

## alternative is using vegan

```{r}
####ALLIN

# Load vegan package
#library(vegan)

# Define assemblages as separate matrices
assemblages <- list(SHADE = SH, SUN = SU, ABANDON = AB, FOREST = FO)
colors <- c("#A6611A", "#DFC27D", "#80CDC1", "#018571")
labels <- c("Shade cacao", "Sun cacao", "Abandoned plantation", "Forest")

# Calculate species accumulation curves for each assemblage
accum_curves <- lapply(assemblages, specaccum)
# Warning: the standard deviation is zeroWarning

# Determine x and y axis limits based on the maximum values from all accumulation curves
x_max <- max(sapply(accum_curves, function(curve) max(curve$sites)))
y_max <- max(sapply(accum_curves, function(curve) max(curve$richness)))
```


# create species accumulation curve
```{r}
# Create an empty plot with refined x and y limits for all assemblages
plot(NULL, xlim = c(0, x_max), ylim = c(0, y_max + 5),  # Add buffer to y-axis for clarity
     xlab = "Sample Size", ylab = "Species Richness",
     main = "Standardized species accumulation curves for each landuse type")

# Loop through each assemblage to add its accumulation curve to the plot
for (i in seq_along(accum_curves)) {
  # Extract the current curve
  curve <- accum_curves[[i]]
  
  # Plot the accumulation curve with lines and add text labels
  lines(curve$sites, curve$richness, col = colors[i], lwd = 2)
  
# Add a legend if needed
legend("bottomright", legend = labels, col = colors, lty = 1, lwd = 2, cex = 0.8)
```










## endangered species
```{r}
threatened_abundance_by_site <- new_threatened %>%
  group_by(Tipo, Final_ID) %>%
  summarize(num_ind = n_distinct(Numero))

threatened_abundance_by_site
```


## REMOVE THIS ONCE PILLAGE CODE


## COME THROUGH AND re analyze this section

## SITE LEVEL

## a. PCA - wary of this, too pretty!

- can only work for continuous variables

https://jcoliver.github.io/learn-r/003-intro-multivariate.html
```{r}
# remove non-numerical columns, previously scaled columns
# pca_fit <- prcomp(
  # x = site_richness_local[, -c(1,5,9,10,14,15,16)], scale. = TRUE)

# actually appears that pca sensitive to scale, so use scaled vars
pca_fit <- prcomp(
  x = site_richness_local[, -c(1,4,6,7,10,11,12)], scale. = TRUE)
                        
pca_summary <- summary(pca_fit)
pca_summary

ls(pca_summary) # Lists the objects produced by summary

pca_summary$importance

# biplot - kinda ugly!
biplot(x = pca_fit)

# just plot first two axes of PCA
plot(x = pca_fit$x[, 1],
     y = pca_fit$x[, 2],
     xlab = "PC 1",
     ylab = "PC 2")

# I don't believe this code is actually filling site colors appropriately

# # what if we included the plantation type for each transect here?
# cacao_type <- unique(site_richness_local$Tipo)
# 
# legend_cols <- c("#A6611A", "#DFC27D")
# 
# # assign colors to legend
# pt_cols <- rep(x = legend_cols[1], length = nrow(site_richness_local))
# pt_cols[cacao_type == cacao_type[2]] <- legend_cols[2]
# 
# # plot just first two axes, include coloring of points for each cacao type
# plot(x = pca_fit$x[, 1],
#      y = pca_fit$x[, 2],
#      xlab = "PC 1",
#      ylab = "PC 2",
#      pch = 19,
#      col = pt_cols)
# legend("bottomleft",
#        legend = cacao_type,
#        pch = 19,
#        col = legend_cols,
#        cex = 0.8)
```

## b. correlation

need to address potential variable correlation before building regression models

visually assess potential correlation of scaled variables in site_richness_local
- no variables appear to be highly correlated (r = 0.7 threshold)
- appears that don't need to remove any!
```{r}
# would only expect local vars or landscape vars to be correlated with each other
ggscatter(site_richness_local, x = "site_mean_hoja_scaled", 
          y = "site_mean_veg_scaled", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "site_mean_hoja_scaled", ylab = "site_mean_veg_scaled")
# r = -.17

ggscatter(site_richness_local, x = "site_mean_hoja_scaled", 
          y = "site_mean_CC_scaled", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "site_mean_hoja_scaled", ylab = "site_mean_CC_scaled")
# r = .79  HIGHLY CORRELATED

ggscatter(site_richness_local, x = "site_mean_veg_scaled", 
          y = "site_mean_CC_scaled", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "site_mean_veg_scaled", ylab = "site_mean_CC_scaled")
# r = -.09

ggscatter(site_richness_local, x = "water_dist_scaled", 
          y = "forest_cover_400_scaled", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "water_dist_scaled", ylab = "forest_cover_400_scaled")
# r = -.41
```

confirm this with correlation matrix
- hoja and CC are strongly correlated at site level - need to address this
```{r}
cor(site_richness_local[, c("site_mean_hoja_scaled", 
                             "site_mean_CC_scaled", 
                             "water_dist_scaled", 
                             "forest_cover_400_scaled",
                             "site_mean_veg_scaled")])
```

create pca variable based off CC and hoja b/c highly correlated
```{r}
pca_CC_hoja <- prcomp(site_richness_local
              [, c("site_mean_hoja_scaled", "site_mean_CC_scaled")], scale. = TRUE)
site_richness_local$pca_CC_hoja <- pca_CC_hoja$x[,1]
```



# c. drivers of site-level amphibian richness
use glmer package to build multiple regression models
- allows for inclusion of both random and rixed effects
- include pca variable of CC and hoja

## SINGULAR FIT BOUNDARY

## full model for species richness
```{r}
# full model singular fit
modfull <- glmer(no_species ~ pca_CC_hoja + # pca of correlated CC, hoja
                   site_mean_veg_scaled + # veg as R.E. prevented model convergence
                   water_dist_scaled + 
                   forest_cover_400_scaled +
                   (1 | Sitio), 
              data = site_richness_local,
              family = poisson())
# BOUNDARY (singular) fit

summary(modfull) 
vif(modfull)
check_overdispersion(modfull)


modfull_2 <- glmer(no_species ~ pca_CC_hoja + # pca of correlated CC, hoja
                   water_dist_scaled + 
                   forest_cover_400_scaled +
                   (1 | Sitio) +
                   (1 | site_mean_veg_scaled), 
              data = site_richness_local,
              family = poisson())
# BOUNDARY (singular) fit

summary(modfull_2) 
vif(modfull_2)
check_overdispersion(modfull_2)
```



# POISSON MODEL OVERDISPERSED - TRY NEGATIVE BINOMIAL?


# CANNOT ASSESS VIF FOR NEGATIVE BINOMIAL MODELS AT SITE LEVEL - WHY?
```{r}
modfull_nb <- glmmTMB(no_species ~ pca_CC_hoja + # pca of correlated CC, hoja
                      water_dist_scaled + 
                      forest_cover_400_scaled +
                      (1 | Sitio) +
                      (1 | site_mean_veg_scaled),
                  data = site_richness_local,
                  family = nbinom2()
                  )

summary(modfull_nb)
vif(modfull_nb) # Error in cov2cor(v) : 'V' is not a square numeric matrix
check_overdispersion(modfull_nb) # not overdispersed

```


## d. drivers of site-level amphibian abundance
```{r}
# full model using glmer, pca, veg RE, poisson
modfull <- glmer(num_ind ~ pca_CC_hoja + # pca of correlated CC, hoja
                   water_dist_scaled + 
                   forest_cover_400_scaled +
                   (1 | Sitio) +
                   (1 | site_mean_veg_scaled), 
              data = site_richness_local,
              family = poisson())
# BOUNDARY (singular) fit

summary(modfull) 
vif(modfull)
check_overdispersion(modfull)

# full model using glmmTMB, pca, veg RE, nbinom2
modfull_nb <- glmmTMB(num_ind ~ pca_CC_hoja + # pca of correlated CC, hoja
                      water_dist_scaled + 
                      forest_cover_400_scaled +
                      (1 | Sitio) +
                      (1 | site_mean_veg_scaled),
                  data = site_richness_local,
                  family = nbinom2()
                  )
# Warning: Model convergence problem; non-positive-definite Hessian matrix. See vignette('troubleshooting')

summary(modfull_nb)
vif(modfull_nb)
check_overdispersion(modfull_nb)

# full model using glmmTMB, pca, veg FE, nbinom2
modfull_nb_2 <- glmmTMB(num_ind ~ pca_CC_hoja + # pca of correlated CC, hoja
                      site_mean_veg_scaled + # veg as FE
                      water_dist_scaled + 
                      forest_cover_400_scaled +
                      (1 | Sitio),
                  data = site_richness_local,
                  family = nbinom2()
                  )

summary(modfull_nb_2)
vif(modfull_nb_2) # Error in cov2cor(v) : 'V' is not a square numeric matrix
check_overdispersion(modfull_nb_2)
```



## REMOVE UP TO HERE







#5. Multiple regression for drivers of amphibian abundance within plantations

Collected a series of local (quad-level), landscape (site-level) variables
- how do these explain the abundance of amphibians at a transect-level?

Start at transect level
- much greater resolution for local variables
- greater statistical power (4 x 23 transects)
- abundance have high enough numbers to work at transect level (not tru for sp)

##a. PCA
- can only work for continuous variables

https://jcoliver.github.io/learn-r/003-intro-multivariate.html
```{r}
pca_fit <- prcomp(
  x = trans_richness_local[, -c(1,2,5,6,7,9,10,11,12,13,14,15)], # remove these columns
                  scale. = TRUE)

pca_summary <- summary(pca_fit)
pca_summary

ls(pca_summary) # Lists the objects produced by summary

pca_summary$importance

# biplot - kinda ugly!
biplot(x = pca_fit)

# just plot first two axes of PCA
plot(x = pca_fit$x[, 1],
     y = pca_fit$x[, 2],
     xlab = "PC 1",
     ylab = "PC 2")
```


##b. correlation

need to address potential variable correlation before building regression models

visually assess potential correlation of scaled variables in trans_richness_local
- tran_mean_hoja_scaled and tran_mean_CC_scaled are highly correlated!
- this makes sense as more leaf coverage above should translate to more below
- so only use one of these variables in model creation
```{r}
# would only expect local vars or landscape vars to be correlated with each other
ggscatter(trans_richness_local, x = "tran_mean_hoja_scaled", 
          y = "tran_mean_veg_scaled", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "tran_mean_hoja_scaled", ylab = "tran_mean_veg_scaled")
# r = -.21

ggscatter(trans_richness_local, x = "tran_mean_hoja_scaled", 
          y = "tran_mean_CC_scaled", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "tran_mean_hoja_scaled", ylab = "tran_mean_CC_scaled")
# r = .7 HIGHLY SCALED

ggscatter(trans_richness_local, x = "tran_mean_veg_scaled", 
          y = "tran_mean_CC_scaled", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "tran_mean_veg_scaled", ylab = "tran_mean_CC_scaled")
# r = .0001

ggscatter(trans_richness_local, x = "water_dist_scaled", 
          y = "forest_cover_400_scaled", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "water_dist_scaled", ylab = "forest_cover_400_scaled")
# r = -.42
```

confirm this with correlation matrix
- tran_mean_CC_scaled and tran_mean_hoja_scaled highly correlated (.7)
```{r}
cor(trans_richness_local[, c("tran_mean_hoja_scaled", 
                             "tran_mean_CC_scaled", 
                             "water_dist_scaled", 
                             "forest_cover_400_scaled",
                             "tran_mean_veg_scaled")])
```

create pca variable based off CC and hoja b/c highly correlated
- probably just end up using tran_mean_hoja but still keep just in case
```{r}
pca_CC_hoja <- prcomp(trans_richness_local
              [, c("tran_mean_hoja_scaled", "tran_mean_CC_scaled")], scale. = TRUE)
trans_richness_local$pca_CC_hoja <- pca_CC_hoja$x[,1]
```

##c. drivers of transect-level amphibian abundance
use glmer package to build full multiple regression
- allows for inclusion of both random and rixed effects 
- use canopy cover instead of hoja, no quantile deviation detected
- work at transect level b/c
```{r}
############# FULL MODEL FITS - AIC 618.5 - CC sig pos ##############
# full model with glmer, CC, veg as R.E., poisson
modfull_abundance <- glmer(num_ind ~ tran_mean_CC + # use CC not hoja
                   water_dist_scaled +
                   forest_cover_400_scaled +
                   (1 | tran_mean_veg_scaled) +
                   (1 | Sitio),
              data = trans_richness_local,
              family = poisson())

summary(modfull_abundance) # tran_mean_CC_sig - AIC 618.5
vif(modfull_abundance) # vif not a concern
check_overdispersion(modfull_abundance) # not overdispersed

# assess model fit using dHARMA - no issues!
simulationOutput <- simulateResiduals(fittedModel = modfull_abundance)
plot(simulationOutput)

testDispersion(simulationOutput) # not over or under dispersed
testZeroInflation(simulationOutput) # zero inflation not required
############# FULL MODEL FITS - AIC 618.5 - CC sig pos ##############

# quantile deviation detected when using hoja instead of CC
# model fit errors when using veg as a fixed effect instead of a random effect
# quantile deviation detected when using negative binomial instead of poisson
```

leave one out cross-validation for candidate models for abundance at transect-level
- start from full model which confirmed fit model assumptions
```{r}
# STEP 1 - remove one predictor variable

############# MODEL NO CC COMBINED ADJUSTED QUANTILE TEST SIG ##############
# full model with glmer, no CC, veg as R.E., poisson
mod_abundance_no_CC <- glmer(num_ind ~ water_dist_scaled +
                   forest_cover_400_scaled +
                   (1 | tran_mean_veg_scaled) +
                   (1 | Sitio),
              data = trans_richness_local,
              family = poisson())

summary(mod_abundance_no_CC) # nothing sig, AIC 629.1
vif(mod_abundance_no_CC) # vif not a concern
check_overdispersion(mod_abundance_no_CC) # not overdispersed

# assess model fit using dHARMA
# CRAZY! deviation sig, combined adjusted quantile test sig
simulationOutput <- simulateResiduals(fittedModel = mod_abundance_no_CC)
plot(simulationOutput)

testDispersion(simulationOutput) # not over or under dispersed
testZeroInflation(simulationOutput) # zero inflation not required
############# MODEL NO CC COMBINED ADJUSTED QUANTILE TEST SIG ##############


############# MODEL NO WATER FITS - AIC 616.5 - CC sig pos ##############
# full model with glmer, no water, veg as R.E., poisson
mod_abundance_no_water <- glmer(num_ind ~ tran_mean_CC_scaled +
                   forest_cover_400_scaled +
                   (1 | tran_mean_veg_scaled) +
                   (1 | Sitio),
              data = trans_richness_local,
              family = poisson())

summary(mod_abundance_no_water) # CC sig, AIC 616.5
vif(mod_abundance_no_water) # vif not a concern
check_overdispersion(mod_abundance_no_water) # not overdispersed

# assess model fit using dHARMA - no issues!
simulationOutput <- simulateResiduals(fittedModel = mod_abundance_no_water)
plot(simulationOutput)

testDispersion(simulationOutput) # not over or under dispersed
testZeroInflation(simulationOutput) # zero inflation not required
############# MODEL NO WATER FITS - AIC 616.5 - CC sig pos ##############


###### MODEL NO FOREST - Quant dev detected (adjusted quantile test n.s) #######
###### - AIC 616.5 - CC sig pos ########
# full model with glmer, no forest, veg as R.E., poisson
mod_abundance_no_forest <- glmer(num_ind ~ tran_mean_CC_scaled +
                   water_dist_scaled +
                   (1 | tran_mean_veg_scaled) +
                   (1 | Sitio),
              data = trans_richness_local,
              family = poisson())

summary(mod_abundance_no_forest) # CC sig, AIC 616.5
vif(mod_abundance_no_forest) # vif not a concern
check_overdispersion(mod_abundance_no_forest) # not overdispersed

# assess model fit using dHARMA - no issues!
simulationOutput <- simulateResiduals(fittedModel = mod_abundance_no_forest)
plot(simulationOutput)

testDispersion(simulationOutput) # not over or under dispersed
testZeroInflation(simulationOutput) # zero inflation not required
###### MODEL NO FOREST - Quant dev detected (adjusted quantile test n.s) #######
###### - AIC 616.5 - CC sig pos ########


# STEP 2 - remove 2nd predictor variable


####### MODEL NO WATER NO FOREST - Quant dev detected (adjusted quantile test sig) ######
###### AIC 614.5 - CC sig pos ######
# full model with glmer, no water, no forest, veg as R.E., poisson
mod_abundance_no_water_forest <- glmer(num_ind ~ tran_mean_CC_scaled +
                   (1 | tran_mean_veg_scaled) +
                   (1 | Sitio),
              data = trans_richness_local,
              family = poisson())

summary(mod_abundance_no_water_forest) # CC sig, AIC 614.5
vif(mod_abundance_no_water_forest) # model contains fewer than two terms
check_overdispersion(mod_abundance_no_water_forest) # not overdispersed

# assess model fit using dHARMA - 
simulationOutput <- simulateResiduals(fittedModel = mod_abundance_no_water_forest)
plot(simulationOutput)

testDispersion(simulationOutput) # not over or under dispersed
testZeroInflation(simulationOutput) # zero inflation not required
####### MODEL NO WATER NO FOREST - Quant dev detected (adjusted quantile test sig) ######
###### AIC 614.5 - CC sig pos ######


####### MODEL NO WATER NO CC - Quant dev detected (adjusted quantile test sig) ######
###### AIC 627.5 - no sig ######
# full model with glmer, no water, no CC, veg as R.E., poisson
mod_abundance_no_water_CC <- glmer(num_ind ~ forest_cover_400_scaled +
                   (1 | tran_mean_veg_scaled) +
                   (1 | Sitio),
              data = trans_richness_local,
              family = poisson())

summary(mod_abundance_no_water_CC) # no sig, AIC 627.5
vif(mod_abundance_no_water_CC) # # model contains fewer than two terms
check_overdispersion(mod_abundance_no_water_CC) # not overdispersed

# assess model fit using dHARMA 
# CRAZY! Quant dev detected, combined adjusted quant test sig
simulationOutput <- simulateResiduals(fittedModel = mod_abundance_no_water_CC)
plot(simulationOutput)

testDispersion(simulationOutput) # not over or under dispersed
testZeroInflation(simulationOutput) # zero inflation not required
####### MODEL NO WATER NO CC - Quant dev detected (adjusted quantile test sig) ######
###### AIC 627.5 - no sig ######


# STOP HERE - none of Step 2 models fit
```

the best fitting candidate model for amphibian abundance contains:
- local canopy cover as a significant positive fixed effect
- surrounding landscape forest cover as a fixed effect
- Site and local herbaceous vegetation cover as random effects




#6. Multiple regression for drivers of amphibian richness in plantations

Drivers of site-level species richness
use glmer package to build multiple regression models
- allows for inclusion of both random and fixed effects 

Work at site-level to improve model fit
- At transect-level many sites have 1-2 species
- Less statistical power at site-level (23 sites), but better understanding of diversity
- Start with the predictor models that were important for transect-level abundance



## WORKING HERE ##

## TURN THIS FROM TRANS INTO SITE


##a. PCA
- can only work for continuous variables

https://jcoliver.github.io/learn-r/003-intro-multivariate.html
```{r}
pca_fit <- prcomp(
  x = trans_richness_local[, -c(1,2,5,6,7,9,10,11,12,13,14,15)], # remove these columns
                  scale. = TRUE)

pca_summary <- summary(pca_fit)
pca_summary

ls(pca_summary) # Lists the objects produced by summary

pca_summary$importance

# biplot - kinda ugly!
biplot(x = pca_fit)

# just plot first two axes of PCA
plot(x = pca_fit$x[, 1],
     y = pca_fit$x[, 2],
     xlab = "PC 1",
     ylab = "PC 2")









## FULL MODEL_3 APPEARS TO WORK


## full model
```{r}
# full model with glmer, no pca, veg as F.E., poisson
modfull <- glmer(num_species ~ tran_mean_hoja_scaled + # no pca - ISSUE
                   tran_mean_CC_scaled + 
                   tran_mean_veg_scaled + 
                   water_dist_scaled + 
                   forest_cover_400_scaled +
                   (1 | Sitio),
              data = trans_richness_local,
              family = poisson())

summary(modfull) # nothing significant - # AIC 1148.1
vif(modfull) # vif not a concern
check_overdispersion(modfull) # not overdispersed!

# full model with glmer, pca_CC_hoja, veg as R.E., poisson
modfull_2 <- glmer(num_species ~ pca_CC_hoja + # use pca
                   water_dist_scaled + 
                   forest_cover_400_scaled +
                   (1 | Sitio) +
                   (1 | tran_mean_veg_scaled), # veg as R.E.
              data = trans_richness_local,
              family = poisson())
# SINGULAR - boundary(singular) fit

summary(modfull_2)
vif(modfull_2)
check_overdispersion(modfull_2)

####### THIS IS THE ONE ##########
# full model with glmer, pca_CC_hoja, veg as F.E., poisson
modfull_3 <- glmer(num_species ~ pca_CC_hoja + # pca of correlated CC, hoja
                   tran_mean_veg_scaled +
                   water_dist_scaled + 
                   forest_cover_400_scaled +
                   (1 | Sitio), 
              data = trans_richness_local,
              family = poisson())

summary(modfull_3) # nothing sig
vif(modfull_3) # vif not concern
check_overdispersion(modfull_3) # not overdispersed
########## USE THIS ONE ##############
```








<!-- ## LOO-CV for candidate models -->
<!-- ```{r} -->
<!-- # model without hoja -->
<!-- mod_no_hoja <- glmer(num_species ~  tran_mean_CC_scaled +  -->
<!--                    tran_mean_veg_scaled +  -->
<!--                    water_dist_scaled +  -->
<!--                    forest_cover_400_scaled + -->
<!--                    (1 | Sitio), -->
<!--               data = trans_richness_local, -->
<!--               family = poisson()) -->
<!-- summary(mod_no_hoja) # nothing significant - # AIC 1147.1 -->
<!-- vif(mod_no_hoja) # vif not a concern -->
<!-- check_overdispersion(mod_no_hoja) # not overdispersed! -->

<!-- # model without canopy cover -->
<!-- mod_no_CC <- glmer(num_species ~ tran_mean_hoja_scaled +  -->
<!--                    tran_mean_veg_scaled +  -->
<!--                    water_dist_scaled +  -->
<!--                    forest_cover_400_scaled + -->
<!--                    (1 | Sitio), -->
<!--               data = trans_richness_local, -->
<!--               family = poisson()) -->
<!-- summary(mod_no_CC) # nothing significant - # AIC 1146.1 -->
<!-- vif(mod_no_CC) # vif not a concern -->
<!-- check_overdispersion(mod_no_CC) # not overdispersed! -->

<!-- # model without veg -->
<!-- mod_no_veg <- glmer(num_species ~ tran_mean_hoja_scaled +  -->
<!--                    tran_mean_CC_scaled +  -->
<!--                    water_dist_scaled +  -->
<!--                    forest_cover_400_scaled + -->
<!--                    (1 | Sitio), -->
<!--               data = trans_richness_local, -->
<!--               family = poisson()) -->
<!-- summary(mod_no_veg) # nothing significant - # AIC 1146.2 -->
<!-- vif(mod_no_veg) # vif not a concern -->
<!-- check_overdispersion(mod_no_veg) # not overdispersed! -->

<!-- # model without water -->
<!-- mod_no_water <- glmer(num_species ~ tran_mean_hoja_scaled +  -->
<!--                    tran_mean_CC_scaled +  -->
<!--                    tran_mean_veg_scaled +  -->
<!--                    forest_cover_400_scaled + -->
<!--                    (1 | Sitio), -->
<!--               data = trans_richness_local, -->
<!--               family = poisson()) -->
<!-- summary(mod_no_water) # nothing significant - # AIC 1146.1 -->
<!-- vif(mod_no_water) # vif not a concern -->
<!-- check_overdispersion(mod_no_water) # not overdispersed! -->

<!-- # model without forest -->
<!-- mod_no_forest <- glmer(num_species ~ tran_mean_hoja_scaled +  -->
<!--                    tran_mean_CC_scaled +  -->
<!--                    tran_mean_veg_scaled +  -->
<!--                    water_dist_scaled +  -->
<!--                    (1 | Sitio), -->
<!--               data = trans_richness_local, -->
<!--               family = poisson()) -->
<!-- summary(mod_no_forest) # nothing significant - # AIC 1146.3 -->
<!-- vif(mod_no_forest) # vif not a concern -->
<!-- check_overdispersion(mod_no_forest) # not overdispersed! -->
<!-- ``` -->









#7. P. achatinus exclusive analysis

##a. Priach percentage visualization
- How does abundance, percentage vary across habitat types?
```{r}
# site_labels here includes all 4 site types b/c comparing percentages
site_labels <-  c("Shade Cacao \n (n = 12)", 
                  "Sun Cacao \n (n = 11)", 
                  "Abandoned Plantation \n (n = 4)",
                  "Remnant Forest \n (n = 5)")

# reorder factor levels
priach_by_site$Tipo <- factor(priach_by_site$Tipo,
                         c("N", "C", "V", "B"))

# plot P. achatinus across landuse types using palet, my_theme
plot_priach_by_site <- ggplot(priach_by_site, 
                                     aes(x = Tipo, y = priach_percentage, 
                                         fill = Tipo)) +
  geom_boxplot() +
  scale_fill_manual(values = pal) + # order needs to match factor levels above
  scale_x_discrete(labels = c(site_labels)) +
  my_theme() + 
  labs(x = "Land use type",
       y = "P. achatinus percentage of total captures")

plot_priach_by_site

ggsave("output/plot_priach_by_site.png", width = 10, height = 10)
```


##b. Priach percentage Kruskal-Wallis across landuse types
- use Kruskal-Wallis b/c ANOVA residuals not normally distributed
- there is no statistically sig difference in priach % between landuse types
```{r}
# ANOVA residuals are not normally distributed
######################################################
# create ANOVA
priach_percentage_aov <- aov(priach_percentage ~ Tipo,
  data = priach_by_site
)
# visually check ANOVA assumption of normality of residuals
par(mfrow = c(1, 2)) # combine plots
# histogram
hist(priach_percentage_aov$residuals)
# QQ-plot
qqPlot(priach_percentage_aov$residuals,
  id = FALSE # id = FALSE to remove point identification
)
# shapiro test for normality - ANOVA is NOT NORMALLY DISTRIBUTED
shapiro.test(priach_percentage_aov$residuals)
######################################################

# so instead use Kruskal-Wallis test b/c doesn't require normality assumptions
priach_percentage_kruskal <- kruskal.test(priach_percentage ~ Tipo, 
                                          data = priach_by_site)
priach_percentage_kruskal
# No significant difference in priach percentage between landuse types
```









