---
title: "ranas_analysis"
author: "Holden Jones"
date: "2024-10-23"
output: html_document
---

Use this document for analyses and figures to be used in paper

# Setup

load packages
```{r, include=FALSE}
library(labdsv)
library(tidyverse)
library(vegan)
library(iNEXT)
library(sjmisc)
library(RColorBrewer) # for assigning plot colors
library(lme4)
library(ggpubr) # for arranging multi-panel figures
library(car)
library(glmmTMB)
library(httr)
library(DHARMa)
library(ggrepel)
library(MASS)
```

load data
```{r, include=FALSE}
ranas <- read_csv("data/processed_data/ranas_processed.csv")
ranas <- as_tibble(ranas)

new <- read_csv("data/processed_data/new_processed.csv")
new <- as_tibble(new)

new_no_priach <- read_csv("data/processed_data/new_no_priach_processed.csv")
new_no_priach <- as_tibble(new_no_priach)

new_threatened <- read_csv("data/processed_data/new_threatened_processed.csv")
new_threatened <- as_tibble(new_threatened)

### REVIEW THIS SECTION ###
new_mat <- read_csv("data/processed_data/new_mat_processed.csv")
new_mat <- as.matrix(new_mat)

new_mat_test <- read_csv("data/processed_data/new_mat_test_processed.csv")
new_mat_test <- as.matrix(new_mat_test)
### REVIEW THIS SECTION ###

site_data <- read_csv("data/processed_data/site_data_processed.csv")
site_data <- as_tibble(site_data)

site_type <- read_csv("data/processed_data/site_type_processed.csv")
site_type <- as_tibble(site_type)

richness_by_site <- read_csv(
  "data/processed_data/richness_by_site_processed.csv")
richness_by_site <- as_tibble(richness_by_site)

richness_by_site_no_priach <- read_csv(
  "data/processed_data/richness_by_site_no_priach_processed.csv")
richness_by_site_no_priach <- as_tibble(richness_by_site_no_priach)

threatened_richness_by_site <- read_csv(
  "data/processed_data/threatened_richness_by_site_processed.csv")
threatened_richness_by_site <- as_tibble(threatened_richness_by_site)

abundance_by_site <- read_csv(
  "data/processed_data/abundance_by_site_processed.csv")
abundance_by_site <- as_tibble(abundance_by_site)

abundance_by_site_no_priach <- read_csv(
  "data/processed_data/abundance_by_site_no_priach_processed.csv")
abundance_by_site <- as_tibble(abundance_by_site_no_priach)

diversity_by_site <- read_csv(
  "data/processed_data/diversity_by_site_processed.csv")
diversity_by_site <- as_tibble(diversity_by_site)

diversity_by_site_no_priach <- read_csv(
  "data/processed_data/diversity_by_site_no_priach_processed.csv")
diversity_by_site_no_priach <- as_tibble(diversity_by_site_no_priach)

trans_richness_local <- read_csv(
  "data/processed_data/trans_richness_local_processed.csv")
trans_richness_local <- as_tibble(trans_richness_local)

trans_richness_local_all <- read_csv(
  "data/processed_data/trans_richness_local_all_processed.csv")
trans_richness_local_all <- as_tibble(trans_richness_local_all)

site_richness_local <- read_csv(
  "data/processed_data/site_richness_local_processed.csv")
site_richness_local <- as_tibble(site_richness_local)

site_richness_local_all <- read_csv(
  "data/processed_data/site_richness_local_all_processed.csv")
site_richness_local_all <- as_tibble(site_richness_local_all)

priach_by_site <- read_csv(
  "data/processed_data/priach_by_site_processed.csv")
priach_by_site <- as_tibble(priach_by_site)

# matrix files for each landuse type
data.shade=read.table("data/processed_data/SHADE.txt", head= T)
data.sun=read.table("data/processed_data/SUN.txt", head= T)
data.for=read.table("data/processed_data/FOREST.txt", head= T)
data.aba=read.table("data/processed_data/ABANDON.txt", head= T)

trans_richness_local_no_priach <- read_csv(
  "data/processed_data/trans_richness_local_no_priach_processed.csv")
trans_richness_local_no_priach <- as_tibble(trans_richness_local_no_priach)

site_richness_local_no_priach <- read_csv(
  "data/processed_data/site_richness_local_no_priach_processed.csv")
site_richness_local_no_priach <- as_tibble(site_richness_local_no_priach)

MATFROGH <- read_csv("data/processed_data/MATFROGH.csv")
MATFROGH <- as_tibble(MATFROGH)
```

define a consistent palet, labels, and theme to be used in figures
```{r, include=FALSE}
# palet for comparisons of all 4 site types
pal <- brewer.pal(4, "BrBG")

# set a theme for ggplots
my_theme <- function() {
  theme_minimal() + 
   theme(legend.position = "none",
        plot.background = element_rect("white"),
        panel.background = element_rect("white"),
        panel.grid = element_line("grey90"),
        axis.line = element_line("gray25"),
        axis.text = element_text(size = 16, color = "gray25"),
        axis.title = element_text(size = 22, color = "gray25"),
        legend.text = element_text(size = 16))
}
```

functions
```{r}
# function for checking model overdispersion
check_overdispersion <- function(model) {
  # Residual deviance and degrees of freedom
  dev <- deviance(model)
  df <- df.residual(model)
  
  # Overdispersion ratio
  ratio <- dev / df
  
  # Test statistic (chi-square distribution)
  p_value <- pchisq(dev, df, lower.tail = FALSE)
  
  # Display the results
  c(Overdispersion = ratio, p_value = p_value)
}
```


#1. Compare abundance, richness and Shannon diversity of shade and sun


What are the means for each of these values for each land use type?
```{r}
site_richness_local_all %>%
  group_by(Tipo) %>%
  summarize(mean(num_ind))

site_richness_local_all %>%
  group_by(Tipo) %>%
  summarize(mean(no_species))

diversity_by_site %>%
  group_by(Tipo) %>%
  summarize(mean(Shannon_Index))
```



##a. Richness
- Use two-sample t-test b/c not perfectly paired in landscape and dif number of sites
- If remove VC-N (weird site turned out to be N, not paired), then can run paired t-test
```{r}
# create species richness vector for each cacao type
rich_ccn <- richness_by_site %>%
  filter(Tipo == 'C') %>%
  pull(no_species)
  
rich_n <- richness_by_site %>%
  filter(Tipo == 'N') %>%
  pull(no_species)

# run two-sample t-test for species richness
t.test(rich_ccn, rich_n, paired = FALSE)
```

- Here run paired t-test w/out VC-N
```{r}
# drop VC-N from df, this site messes up pairing for t-test
pair_rich_by_site <- richness_by_site %>%
  filter(Sitio != 'VC-N') %>%
  arrange(Pair) # sort by Pair so vectors pulled align with pairs

# create species richness vector for each cacao type
pair_rich_ccn <- pair_rich_by_site %>%
  filter(Tipo == 'C') %>%
  pull(no_species)
  
pair_rich_n <- pair_rich_by_site %>%
  filter(Tipo == 'N') %>%
  pull(no_species)

t.test(pair_rich_ccn, pair_rich_n, paired = TRUE)
```

Boxplot figure for CCN vs. Nacional species richness
```{r}
# site labels for 2 site comparison
site_labels <-  c("Shade \n (n = 12)", "Sun \n (n = 11)")

# reorder factor levels
richness_by_site$Tipo <- factor(richness_by_site$Tipo,
                         c("N", "C", "V", "B"))

richness_by_site_cacao <- richness_by_site %>%
  filter(Tipo == "C" | Tipo == 'N')

# plot species richness across landuse types using palet, my_theme
plot_richness_by_site_cacao <- ggplot(richness_by_site_cacao, 
                                     aes(x = Tipo, y = no_species, fill = Tipo)) +
  geom_boxplot() +
  scale_fill_manual(values = pal) + # order needs to match factor levels above
  scale_x_discrete(labels = c(site_labels)) +
  my_theme() + 
  labs(x = "Cacao type",
       y = "Species richness")
plot_richness_by_site_cacao
#ggsave("output/plot_richness_by_site_cacao.png", width = 10, height = 10)

# below using ggarrange to align multiple figs - don't want to repeat axis labels
plot_richness_by_site_cacao_arrange <- ggplot(richness_by_site_cacao, 
                                     aes(x = Tipo, y = no_species, fill = Tipo)) +
  geom_boxplot() +
  scale_fill_manual(values = pal) + 
  scale_y_continuous(limits = c(2, 10)) +
  scale_x_discrete(labels = c(site_labels)) +
  my_theme() + 
  theme(axis.title.x=element_blank(),
        #axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  labs(y = "Richness")
plot_richness_by_site_cacao_arrange
```


##b. Shannon diversity
Compare Shannon diversity of CCN and Nacional
- same process as above, can be done with paired or two-sample t-test

two-sample t-test
```{r}
# Two sample t-test for shannon diversity:

# create Shannon diversity vector for each cacao type
shannon_ccn <- diversity_by_site %>%
  filter(Tipo == 'C') %>%
  pull(Shannon_Index)
  
shannon_n <- diversity_by_site %>%
  filter(Tipo == 'N') %>%
  pull(Shannon_Index)

# run two-sample t-test for shannon diversity
t.test(shannon_ccn, shannon_n, paired = FALSE)
```

paired t-test
```{r}
# Paired t-test for Shannon diversity 

# drop VC-N from df, this site messes up pairing for t-test
pair_diversity_by_site <- diversity_by_site %>%
  filter(Sitio != 'VC-N') %>%
  arrange(Pair) # sort by Pair so vectors pulled align with pairs

# create Shannon diversity vector for each cacao type
pair_shannon_ccn <- pair_diversity_by_site %>%
  filter(Tipo == 'C') %>%
  pull(Shannon_Index)
  
pair_shannon_n <- pair_diversity_by_site %>%
  filter(Tipo == 'N') %>%
  pull(Shannon_Index)

t.test(pair_shannon_ccn, pair_shannon_n, paired = TRUE)
```

Boxplot figure for CCN vs. Nacional Shannon diversity
```{r}
# reorder factor levels
diversity_by_site$Tipo <- factor(diversity_by_site$Tipo,
                         c("N", "C", "V", "B"))

shannon_by_site_cacao <- diversity_by_site %>%
  filter(Tipo == "C" | Tipo == 'N')

# plot Shannon diversity across landuse types using palet, my_theme
plot_shannon_by_site_cacao <- ggplot(shannon_by_site_cacao, 
                                     aes(x = Tipo, y = Shannon_Index, 
                                         fill = Tipo)) +
  geom_boxplot() +
  scale_fill_manual(values = pal) + # order needs to match factor levels above
  scale_x_discrete(labels = c(site_labels)) +
  my_theme() + 
  labs(x = "Cacao type",
       y = "Shannon index")

plot_shannon_by_site_cacao
#ggsave("output/plot_shannon_by_site_cacao.png", width = 10, height = 10)

# below using ggarrange to align multiple figs
plot_shannon_by_site_cacao_arrange <- ggplot(shannon_by_site_cacao, 
                                     aes(x = Tipo, y = Shannon_Index, 
                                         fill = Tipo)) +
  geom_boxplot() +
  scale_fill_manual(values = pal) + 
  scale_x_discrete(labels = c(site_labels)) +
  scale_y_continuous(limits = c(0, 1.6)) +
  my_theme() + 
  labs(x = "Cacao type",
       y = "Shannon index")

plot_shannon_by_site_cacao_arrange
```



## ABUNDANCE_BY_SITE IS WRONG

##c. Abundance
Same process as above - use abundance_by_site for two sample t-test
```{r}
# create species abundance vector for each cacao type
abun_ccn <- site_richness_local %>%
  filter(Tipo == 'C') %>%
  pull(num_ind)

abun_n <- site_richness_local %>%
  filter(Tipo == 'N') %>%
  pull(num_ind)

# run two-sample t-test for species richness
t.test(abun_ccn, abun_n, paired = FALSE)
```

paired t-test
```{r}
# drop VC-N from df, this site messes up pairing for t-test
pair_site_richness_local <- site_richness_local %>%
  filter(Sitio != 'VC-N') %>%
  arrange(Pair) # sort by Pair so vectors pulled align with pairs

# create abundance vector for each cacao type
pair_abun_ccn <- pair_site_richness_local %>%
  filter(Tipo == 'C') %>%
  pull(num_ind)
  
pair_abun_n <- pair_site_richness_local %>%
  filter(Tipo == 'N') %>%
  pull(num_ind)

t.test(pair_abun_ccn, pair_abun_n, paired = TRUE)
```

Boxplot figure for CCN vs. Nacional abundance
```{r}
# site labels for 2 site comparison
site_labels <-  c("Shade \n (n = 12)", "Sun \n (n = 11)")

# reorder factor levels
site_richness_local$Tipo <- factor(site_richness_local$Tipo,
                         c("N", "C", "V", "B"))

site_richness_local_cacao <- site_richness_local %>%
  filter(Tipo == "C" | Tipo == 'N')

# plot species richness across landuse types using palet, my_theme
plot_abundance_by_site_cacao <- ggplot(site_richness_local_cacao, 
                                     aes(x = Tipo, y = num_ind, fill = Tipo)) +
  geom_boxplot() +
  scale_fill_manual(values = pal) + # order needs to match factor levels above
  scale_x_discrete(labels = c(site_labels)) +
  my_theme() + 
  labs(x = "Cacao type",
       y = "Amphibian abundance")

plot_abundance_by_site_cacao
#ggsave("output/plot_abundance_by_site_cacao.png", width = 10, height = 10)

# below using ggarrange to align multiple figs - don't want to repeat axis labels
plot_abundance_by_site_cacao_arrange <- ggplot(site_richness_local_cacao, 
                                     aes(x = Tipo, y = num_ind, fill = Tipo)) +
  geom_boxplot() +
  scale_fill_manual(values = pal) + 
  scale_y_continuous(limits = c(0, 180)) +
  scale_x_discrete(labels = c(site_labels)) +
  my_theme() + 
  theme(axis.title.x=element_blank(),
        #axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  labs(y = "Abundance")
plot_abundance_by_site_cacao_arrange
```


#2.Compare abundance, richness and Shannon diversity of forest and abandoned plantations

##a. NMDS ordination plot - this should go below with contextualize??!
- using new_mat df, species-by-site abundance matrix
- draw boundaries of landuse types
- possible that this figure doesn't ultimately get included in MS
```{r}
#### Order new_mat df ####
three_column <- new %>%
  group_by(Sitio) %>%
  count(`Final_ID`)

# needs to be converted to data.frame!
three_column <- data.frame(three_column)

new_mat <- matrify(three_column)

# Define the desired order of rows: Shade, Sun, Abandoned, Forest
new_order <- c(1,3,5,8,19,20,22,25,27,29,30,32, # shade (n=12)
               2,4,7,16,18,21,23,24,26,28,31, # sun (n=11)
               9,13,14,17, # abandoned (n=4)
               6,10,11,12,15 # forest (n=5)
               )

# Reorder rows
new_mat <- new_mat[new_order, ]


#### Make ordination plot ####

# assign treatment levels per landuse type on reordered new_mat
landuse_treatments=c(rep("Shade",12),
                      rep("Sun",11), 
                      rep("Abandoned",4), 
                      rep("Forest",5))

# use community by species matrix - stress = 0.26 - okay representation
new_mat_NMDS = metaMDS(new_mat, k = 2)

# sites are open circles, species are red crosses
plot(new_mat_NMDS)


# help visualize by labeling specific sites and species

# ordination plot function especially for congested plots
ordiplot(new_mat_NMDS,type="n")
# this function adds text or points to ordination plots
orditorp(new_mat_NMDS,display="species",col="red",air=0.01)

orditorp(new_mat_NMDS,display="sites",cex=1.25,air=0.01)

ordiplot(new_mat_NMDS,type="n")

ordihull(new_mat_NMDS,groups=landuse_treatments,draw="polygon",
         col="grey90",label=F)

orditorp(new_mat_NMDS,display="species",col="red",air=0.01)

# here colors need to align with landuse_treatments from above!
# of course need to use chocolate!
orditorp(new_mat_NMDS,display="sites",col=c(rep("chocolate4",12),
                                            rep("chocolate1",11),
                                            rep("lightgreen",4),
                                            rep("darkgreen",5)), 
         air=0.01,cex=1.25)
```


##b. Richness
- Use two-sample t-test b/c not paired and dif number of sites
```{r}
# create species richness vector for each cacao type
rich_forest <- richness_by_site %>%
  filter(Tipo == 'B') %>%
  pull(no_species)
  
rich_abandon <- richness_by_site %>%
  filter(Tipo == 'V') %>%
  pull(no_species)

# run two-sample t-test for species richness
t.test(rich_forest, rich_abandon, paired = FALSE)
```

Boxplot figure for forest vs. abandoned species richness
```{r}
site_labels <- c("Abandoned \n (n = 4)", "Forest \n (n = 5)")

# reorder factor levels
richness_by_site$Tipo <- factor(richness_by_site$Tipo,
                         c("N", "C", "V", "B"))

richness_by_site_inactive <- richness_by_site %>%
  filter(Tipo == "B" | Tipo == 'V')

# plot species richness across landuse types using palet, my_theme
plot_richness_by_site_inactive <- ggplot(richness_by_site_inactive, 
                                     aes(x = Tipo, y = no_species, 
                                         fill = Tipo)) +
  geom_boxplot() +
  scale_fill_manual(values = c("#80CDC1", "#018571")) +
  scale_x_discrete(labels = c(site_labels)) +
  my_theme() + 
  labs(x = "Reference type",
       y = "Species richness")

plot_richness_by_site_inactive
#ggsave("output/plot_richness_by_site_inactive.png", width = 10, height = 10)

# below using ggarrange to align multiple figs - don't want to repeat x axes labels
plot_richness_by_site_inactive_arrange <- ggplot(richness_by_site_inactive, 
                                     aes(x = Tipo, y = no_species, fill = Tipo)) +
  geom_boxplot() +
  scale_fill_manual(values = c("#80CDC1", "#018571")) + 
  scale_y_continuous(limits = c(2, 10)) +
  scale_x_discrete(labels = c(site_labels)) +
  my_theme() + 
  theme(axis.title.x = element_blank(),
       # axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.y = element_blank(), #,
       # axis.text.y = element_blank() ,
        axis.ticks.y = element_blank()
        )
plot_richness_by_site_inactive_arrange
```


##c. Shannon diversity
Compare Shannon diversity of abandoned plantations and remnant forest

two-sample t-test
```{r}
# Two sample t-test for shannon diversity:

# create Shannon diversity vector for each type
shannon_abandon <- diversity_by_site %>%
  filter(Tipo == 'V') %>%
  pull(Shannon_Index)
  
shannon_forest <- diversity_by_site %>%
  filter(Tipo == 'B') %>%
  pull(Shannon_Index)

# run two-sample t-test for shannon diversity
t.test(shannon_abandon, shannon_forest, paired = FALSE)
```

Boxplot figure for abandoned vs. forest Shannon diversity
```{r}
site_labels <- c("Abandoned \n (n = 4)", "Forest \n (n = 5)")

# reorder factor levels
diversity_by_site$Tipo <- factor(diversity_by_site$Tipo,
                         c("N", "C", "V", "B"))

shannon_by_site_inactive <- diversity_by_site %>%
  filter(Tipo == "V" | Tipo == 'B')

# plot Shannon diversity across landuse types using palet, my_theme
plot_shannon_by_site_inactive <- ggplot(shannon_by_site_inactive, 
                                     aes(x = Tipo, y = Shannon_Index, 
                                         fill = Tipo)) +
  geom_boxplot() +
  scale_fill_manual(values = c("#80CDC1", "#018571")) +
  scale_x_discrete(labels = c(site_labels)) +
  my_theme() + 
  labs(x = "Reference type",
       y = "Shannon diversity")

plot_shannon_by_site_inactive
#ggsave("output/plot_shannon_by_site_inactive.png", width = 10, height = 10)

# below using ggarrange to align multiple figs - here don't want y axis legends
plot_shannon_by_site_inactive_arrange <- ggplot(shannon_by_site_inactive, 
                                     aes(x = Tipo, y = Shannon_Index, 
                                         fill = Tipo)) +
  geom_boxplot() +
  scale_fill_manual(values = c("#80CDC1", "#018571")) + 
  scale_x_discrete(labels = c(site_labels)) +
  scale_y_continuous(limits = c(0, 1.6)) +
  my_theme() + 
  labs(x = "Reference type") +
  theme(axis.title.y = element_blank(),
        #axis.text.y = element_blank() #,
        axis.ticks.y = element_blank()
        )
plot_shannon_by_site_inactive_arrange
```


##d. Abundance
Same process as above - use site_richness_local_all for two sample t-test
```{r}
# create species abundance vector for each cacao type
abun_abandon <- site_richness_local_all %>%
  filter(Tipo == 'V') %>%
  pull(num_ind)
  
abun_forest <- site_richness_local_all %>%
  filter(Tipo == 'B') %>%
  pull(num_ind)

# run two-sample t-test for species richness
t.test(abun_abandon, abun_forest, paired = FALSE)
```

Boxplot figure for forest vs. abandoned abundance
```{r}
# reorder factor levels
site_richness_local_all$Tipo <- factor(site_richness_local_all$Tipo,
                         c("N", "C", "V", "B"))

site_richness_local_inactive <- site_richness_local_all %>%
  filter(Tipo == "V" | Tipo == 'B')

# plot Shannon diversity across landuse types using palet, my_theme
plot_abundance_by_site_inactive <- ggplot(site_richness_local_inactive, 
                                     aes(x = Tipo, y = num_ind, 
                                         fill = Tipo)) +
  geom_boxplot() +
  scale_fill_manual(values = c("#80CDC1", "#018571")) +
  scale_x_discrete(labels = c(site_labels)) +
  my_theme() + 
  labs(x = "Reference type",
       y = "Amphibian abundance")
plot_abundance_by_site_inactive
#ggsave("output/plot_abundance_by_site_inactive.png", width = 10, height = 10)

# below using ggarrange to align multiple figs, don't want to repeat axes
plot_abundance_by_site_inactive_arrange <- ggplot(site_richness_local_inactive, 
                                     aes(x = Tipo, y = num_ind, fill = Tipo)) +
  geom_boxplot() +
  scale_fill_manual(values = c("#80CDC1", "#018571")) + 
  scale_y_continuous(limits = c(0, 180)) +
  scale_x_discrete(labels = c(site_labels)) +
  my_theme() + 
  theme(axis.title.x = element_blank(),
        #axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.y = element_blank(),
        #axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
plot_abundance_by_site_inactive_arrange
```


##e. Arrange figures for publication
arrange these four or six figures as panels in one window
```{r}
# richness and shannon diversity
compare_rich_shannon <- ggarrange(
  plot_richness_by_site_cacao + rremove("xlab"), 
  plot_richness_by_site_inactive + rremove("xlab") + rremove("ylab"),
  plot_shannon_by_site_cacao,
  plot_shannon_by_site_inactive + rremove("ylab"),
  labels = c("A", "B", "C", "D"),
  ncol = 2, nrow = 2,
  label.x = 0.01, 
  label.y = 0.08 
)

compare_rich_shannon
#ggsave("output/compare_rich_shannon.png", width = 10, height = 10)

# abundance, richness and shannon diversity
compare_abun_rich_shannon <- ggarrange(
  plot_abundance_by_site_cacao_arrange + rremove("xlab"), 
  plot_abundance_by_site_inactive_arrange + rremove("xlab") + rremove("ylab"),
  plot_richness_by_site_cacao_arrange + rremove("xlab"), 
  plot_richness_by_site_inactive_arrange + rremove("ylab"),
  plot_shannon_by_site_cacao_arrange,
  plot_shannon_by_site_inactive_arrange + rremove("ylab"),
  labels = c("a", "b", "c", "d", "e", "f"),
  ncol = 2, nrow = 3,
  label.x = 0.015, #.01
  label.y = 0.13,  #.13
  font.label = list(size = 20, face = "bold")
)
compare_abun_rich_shannon
#ggsave("output/compare_abun_rich_shannon_submit.png", width = 10, height = 10)
```


#3. Contextualize cacao sites against reference sites


To do this, need to use estimates of asymptotic species richness 
- b/c these sites did not have even sample coverage
- Compare rarefied specues richness across different landuse types
- use vegan package

create separate matrix for each landuse type
```{r}
# shade
head(data.shade)
# convert the data frame into a list matrix for inext
SH <- as.matrix(apply(data.shade[,-1],2, as.integer))
# site name as row names
row.names(SH) <- data.shade[,1]

# sun
head(data.sun)
SU <- as.matrix(apply(data.sun[,-1],2, as.integer))
row.names(SU) <- data.sun[,1]

# abandoned
head(data.aba)
AB <- as.matrix(apply(data.aba[,-1],2, as.integer))
row.names(AB) <- data.aba[,1]

# forest
head(data.for)
# # ### what happens if remove FLL-B dud site?
# data.for <- data.for[1:4,] 
FO <- as.matrix(apply(data.for[,-1],2, as.integer))
row.names(FO) <- data.for[,1]
```


##a. Species accumulation curve
```{r}
# Define assemblages as separate matrices
assemblages <- list(SHADE = SH, SUN = SU, ABANDON = AB, FOREST = FO)
colors <- c("#A6611A", "#DFC27D", "#80CDC1", "#018571")
labels <- c("Shade cacao", "Sun cacao", "Abandoned plantation", "Forest")

# Calculate species accumulation curves for each assemblage
accum_curves <- lapply(assemblages, 
                       function(x) specaccum(x, 
                                             method = "random", 
                                             permutations = 100))

# Determine x and y axis limits based on the maximum values from all accumulation curves
x_max <- max(sapply(accum_curves, function(curve) max(curve$sites)))
y_max <- max(sapply(accum_curves, function(curve) max(curve$richness)))

#### Create species accumulation plot with confidence intervals ####
# Create an empty plot with refined x and y limits for all assemblages
plot(NULL, xlim = c(0, x_max), ylim = c(0, y_max + 5),  # Add buffer to y-axis
     xlab = "Sample Size", ylab = "Species Richness",
     main = "Standardized species accumulation curves for each landuse type")

# Loop through each assemblage, add accumulation curve and CI to the plot
for (i in seq_along(accum_curves)) {
  # Extract the current curve
  curve <- accum_curves[[i]]
  
  # Plot the confidence interval as a shaded polygon
  polygon(c(curve$sites, rev(curve$sites)), 
          c(curve$richness + curve$sd, rev(curve$richness - curve$sd)),
          col = adjustcolor(colors[i], alpha.f = 0.2), border = NA)
  
  # Plot the accumulation curve with lines
  lines(curve$sites, curve$richness, col = colors[i], lwd = 2)
}

# Add a legend to the plot (outside the loop)
legend("bottomright", legend = labels, col = colors, lty = 1, lwd = 2, cex = 0.8)
```


##b. Rarefaction

Technique to assess expected species richness
- allows calculation of species richness for given number of samples based on
  construction of rarefaction curves
  
issue is that the larger number of ind sampled, more species will be found
- rarefaction curves created by randomly re-sampling pool of N samples multiple
  times and then plotting average number of species found in each sample
- rarefaction generates expected number of species in small collection of n ind
  drawn from large pool of N samples
- typically grow rapidly at first, then slowly as only rarest species remain to
  be sampled

use rarefy and rarecurve functions
```{r}
# define rarefaction depth - smallest total abundance from four matrices
min_sample_size <- min(rowSums(SH), rowSums(SU), rowSums(AB), rowSums(FO))

# perform the rarefaction - expected species richness if each sample standardized to min
rarefied_richness_shade <- rarefy(SH, min_sample_size)
rarefied_richness_sun <- rarefy(SU, min_sample_size)
rarefied_richness_abandon <- rarefy(AB, min_sample_size)
rarefied_richness_forest <- rarefy(FO, min_sample_size)

# combine results and calculate means for each land use type for easy comparison:
mean_rarefied_richness <- c(mean(rarefied_richness_shade), 
                   mean(rarefied_richness_sun), 
                   mean(rarefied_richness_abandon), 
                   mean(rarefied_richness_forest))

# visualize simple plot
boxplot(rarefied_richness_shade, 
        rarefied_richness_sun, 
        rarefied_richness_abandon, 
        rarefied_richness_forest,
        names = c("Shade cacao", "Sun cacao", "Abandoned cacao", "Forest"),
        ylab = "Rarefied Species Richness")
```

not totally necessary, but interesting to see dist. of ind at site and sp level
```{r}
# abundances for each site
site_abun <- rowSums(new_mat)
site_abun

# abundances for each species
sp_abun <- colSums(new_mat)
sp_abun
```

run rarefaction with all sites
- this is the default
```{r}
raremin <- min(rowSums(new_mat))
raremin # min ind in a site is 6 from VC-C

# run rarefaction with all sites (including super low site VC-C)
sRare <- rarefy(new_mat, raremin)
sRare

# join diversity_by_site data with sRare in a df
diversity_by_site <- sRare %>% 
  enframe() %>% 
  full_join(diversity_by_site, by = c("name" = "Sitio")) %>%
  rename(sRare = value)

# Anova for rarefied species richness by tpe
sRare_aov <- aov(sRare ~ Tipo, data = diversity_by_site)
summary(sRare_aov)
# p-value is 0.266, not sig difference
```


rarefaction uses smallest number of obs per sample to extrapolate expected
number if all other samples only had that number of obs
- VC-C only had 6!!! This certainly impacts the results of rarefaction
- try running rarefaction analysis without this site, see how this impacts things
- of course present this caveat!
```{r}
# remove VC-C from new_mat matrix via row position
new_mat_abundant <- new_mat %>%
  filter(!row_number() %in% c(23))
new_mat_abundant # confirmed VC-C is absent

# let's see what happens with this as our raremin - now set at 22
raremin_abundant <- min(rowSums(new_mat_abundant))
raremin_abundant

# expected rarefied species richness if only 22 ind collected at each site
sRare_abundant <- rarefy(new_mat_abundant, raremin_abundant)
sRare_abundant

# remove VC-C from diversity_by_site to ensure full_join happens
diversity_by_site_abundant <- diversity_by_site %>%
  filter(!name == 'VC-C')

# join diversity_by_site_abundant with sRare_abundant in a df
diversity_by_site_abundant <- sRare_abundant %>% 
  enframe() %>% 
  left_join(diversity_by_site_abundant, by = "name") %>%
  rename(sRare_abundant = value)

# Anova for rarefied species richness by type without VC-C
sRare_abundant_aov <- aov(sRare_abundant ~ Tipo, 
                          data = diversity_by_site_abundant)
summary(sRare_abundant_aov) # p-value 0.205, not sig difference
```

no difference in findings based on inclusion / exclusion of VC-C, so include it
```{r}
# site labels for 4 site comparison
site_labels <-  c("Shade Cacao \n (n = 12)", 
                  "Sun Cacao \n (n = 11)", 
                  "Abandoned Plantation \n (n = 4)",
                  "Remnant Forest \n (n = 5)")

# reorder factor levels to match site_labels
diversity_by_site$Tipo <- factor(diversity_by_site$Tipo,
                         c("N", "C", "V", "B"))

# plot rarefied species richness across landuse types using palet, my_theme
plot_rare_by_type <- ggplot(diversity_by_site, 
                                     aes(x = Tipo, y = sRare, fill = Tipo)) +
  geom_boxplot() +
  scale_fill_manual(values = pal) + # order needs to match factor levels above
  scale_x_discrete(labels = c(site_labels)) +
  my_theme() + 
  labs(x = "Land use type",
       y = "Rarefied species richness")

plot_rare_by_type
#ggsave("output/plot_rare_by_type.png", width = 10, height = 10)
```


##c. Extrapolation

use iNEXT to make rarefaction curves of each site type
- this figure doesn't have extrapolation - vegan is doing the same thing above
```{r}
#load matrix
attach(MATFROGH)
data <- MATFROGH

# Check the structure of your matrix
str(MATFROGH)

# Ensure Type is a factor
MATFROGH$Type <- as.factor(MATFROGH$Type)

# Summarize abundances for each Type and split into a list
abundance_list <- MATFROGH %>%
  group_by(Type) %>%
  summarise(across(where(is.numeric), sum)) %>%  # Summarize numeric columns
  split(.$Type)  # Split the summarized data by Type

# Remove the Type column within each list element
abundance_list <- lapply(abundance_list, function(x) x[, -1])  # Drop 'Type' column

# Summarize abundances for each Type and split into numeric vectors
abundance_list <- MATFROGH %>%
  group_by(Type) %>%
  summarise(across(where(is.numeric), sum)) %>%
  split(.$Type)  # Split by Type

# Convert each element of the list to a numeric vector
abundance_list <- lapply(abundance_list, 
                         function(x) as.numeric(x[, -1]))  # Drop the 'Type' column

# Check the structure of abundance_list
str(abundance_list)

###RAREFACTION###
rare_results <- iNEXT(abundance_list, q = 0, datatype = "abundance")

rare_results
# Plot the rarefaction curves

ggiNEXT(rare_results, type = 1) +
  ggtitle("Rarefaction Curves by Habitat Type") +
  xlab("Sample Size") +
  ylab("Species Richness")
```

## WORKING

use iNEXT to extrapolate rarefaction curve to see what expected values would be
- visually compare extrapolated rarefied species richness across landuse types
- calculate extrapolated rarefied species richness
```{r}
###VISUALIZATION###
# Perform rarefaction analysis with extended extrapolation
rare_results_extended <- iNEXT(abundance_list, q = 0, 
                               datatype = "abundance", endpoint = 2000)

# Plot rarefaction/extrapolation curves with extended extrapolation
ggiNEXT(rare_results_extended, type = 1) +
  ggtitle("Extended Rarefaction and Extrapolation Curves by Habitat Type") +
  xlab("Sample Size") +
  ylab("Species Richness")



extrapolated_rich_plot <- ggiNEXT(rare_results_extended, type = 1) +
  scale_x_discrete(labels = c(site_labels)) +
  my_theme() +
  labs(x = "Sample size",
       y = "Rarefied species richness")

extrapolated_rich_plot

###############################################################################
### THIS IS SO SO SO CLOSE! JUST NEED TO CHANGE DISPLAY OF VALUES!!!!!

# working:
ggiNEXT(rare_results_extended, type = 1) +
  ggtitle("Extended Rarefaction and Extrapolation Curves by Habitat Type") +
  xlab("Sample Size") +
  ylab("Species Richness") +
  theme_minimal() +
  scale_color_manual(values = c("ABANDON" = "#80CDC1", 
                                "FOREST" = "#018571", 
                                "SHADE" = "#A6611A",
                                "SUN" = "#DFC27D"),
                      labels = c("ABANDON" = "Abandoned", 
                                 "FOREST" = "Forest", 
                                 "SHADE" = "Shade", 
                                  "SUN" = "Sun") 
                     ) 

###############################################################################

# ERRORS BELOW HERE

# # Extract the iNextEst data frame
# extrapolated_richness <- rare_results_extended$iNextEst
# 
# # Check the structure
# str(extrapolated_richness)
# 
# # View the data
# head(extrapolated_richness)
# 
# # Extract size-based extrapolated richness values
# extrapolated_summary <- extrapolated_richness$size_based %>%
#   filter(Method == "Extrapolation", m == 2000) %>%
#   select(Assemblage, m, qD, qD.LCL, qD.UCL)
# 
# # Print the summary
# print(extrapolated_summary)
```






## final for submitted MS

# prep matrix for iNEXT
```{r}
#load matrix
attach(MATFROGH)
data <- MATFROGH

# Check the structure of your matrix
str(MATFROGH)

# Ensure Type is a factor
MATFROGH$Type <- as.factor(MATFROGH$Type)

# Summarize abundances for each Type and split into a list
abundance_list <- MATFROGH %>%
  group_by(Type) %>%
  summarise(across(where(is.numeric), sum)) %>%  # Summarize numeric columns
  split(.$Type)  # Split the summarized data by Type

# Remove the Type column within each list element
abundance_list <- lapply(abundance_list, function(x) x[, -1])  # Drop 'Type' column

# Summarize abundances for each Type and split into numeric vectors
abundance_list <- MATFROGH %>%
  group_by(Type) %>%
  summarise(across(where(is.numeric), sum)) %>%
  split(.$Type)  # Split by Type

# Convert each element of the list to a numeric vector
abundance_list <- lapply(abundance_list, 
                         function(x) as.numeric(x[, -1]))  # Drop the 'Type' column

# Check the structure of abundance_list
str(abundance_list)


name_map <- c("ABANDON" = "Abandoned",
              "FOREST" = "Forest",
              "SHADE" = "Shade",
              "SUN" = "Sun")

names(abundance_list) <- name_map[names(abundance_list)]
```



use iNEXT to extrapolate rarefaction curve to see what expected values would be
- visually compare extrapolated rarefied species richness across landuse types
- calculate extrapolated rarefied species richness
```{r}
###VISUALIZATION###
# Perform rarefaction analysis with extended extrapolation
rare_results_extended <- iNEXT(abundance_list, q = 0, 
                               datatype = "abundance", endpoint = 1000)

plot_extrap_submit <- ggiNEXT(rare_results_extended, type = 1) +
  xlab("Number of individuals sampled") +
  ylab("Species richness") +
  scale_color_manual(values = c(
    "Shade" = "#A6611A",
    "Sun" = "#DFC27D", 
    "Abandoned" = "#80CDC1", 
    "Forest" = "#018571"
  )) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid = element_blank(),         # Remove all gridlines
    axis.line = element_line(color = "black"),  # Add axis lines
    axis.ticks = element_line(color = "black"), # Keep tick marks
    axis.title = element_text(size = 16, face = "bold"), 
    axis.text = element_text(size = 14), 
    legend.title = element_blank(),
    legend.text = element_text(size = 14),
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5)
  )
plot_extrap_submit
ggsave("output/plot_extrap_submit.png", width = 10, height = 10)
```


## boxplot of extrapolated species richness

```{r}
# # Combine all extrapolated values into one data frame
# extrapolated_df <- rare_results_extended$iNextEst$size_based
# 
# # Filter for extrapolation at exactly 1000 individuals
# extrapolated_summary <- extrapolated_df %>%
#   dplyr::filter(Method == "Extrapolation", m == 1000, Order.q == 0) %>%
#   dplyr::select(Assemblage, m, qD, qD.LCL, qD.UCL)
# 
# # Print the summary
# print(extrapolated_summary)
# 
# 
# library(ggplot2)
# 
# ggplot(extrapolated_summary, aes(x = Assemblage, y = qD, fill = Assemblage)) +
#   geom_boxplot() +
#   geom_errorbar(aes(ymin = qD.LCL, ymax = qD.UCL), width = 0.2) +
#   scale_fill_manual(values = c("ABANDON" = "#80CDC1", 
#                                "FOREST" = "#018571", 
#                                "SHADE" = "#A6611A",
#                                "SUN" = "#DFC27D")) +
#   labs(title = "Extrapolated Species Richness at 2000 Individuals",
#        x = "Habitat Type", y = "Estimated Species Richness") +
#   theme_minimal()


```







##d. Endangered species
```{r}
threatened_abundance_by_site <- new_threatened %>%
  group_by(Tipo, Final_ID) %>%
  summarize(num_ind = n_distinct(Numero))

threatened_abundance_by_site
```


##e. Dissimilarity indices

## CANNOT DISPLAY SPECIES OVER NMDS FOR DISSIMILARITY MATRIX - do I have to?
```{r}
# # Create a site type vector
# site_types <- c(rep("Shade cacao", 12), 
#                 rep("Sun cacao", 11), 
#                 rep("Abandoned plantation", 4), 
#                 rep("Remnant forest", 5))
# 
# dissimilarity_matrix <- vegdist(new_mat, method = "bray")
# 
# # NMDS of dissimilarity matrix - used by Mendenhall!
# nmds <- metaMDS(dissimilarity_matrix, k = 2) # stress of .08
# plot(nmds)
# 
# # PCA - (if dissimilarities are not too high-dimensional)
# pca <- cmdscale(dissimilarity_matrix, k = 2)
# plot(pca[, 1], pca[, 2], xlab = "PC1", ylab = "PC2")
# 
# # visualize and color by site type
# nmds_data <- as.data.frame(scores(nmds))
# nmds_data$site_type <- factor(site_types, 
#                               levels = c("Shade cacao", "Sun cacao", 
#                                          "Abandoned plantation", "Remnant forest"))
# 
# # plot with ggplot, color by site type
# plot_nmds_bray <- ggplot(nmds_data, aes(x = NMDS1, y = NMDS2, 
#                                         color = site_type)) +
#   geom_point(size = 4) +
#   scale_color_manual(values = c("Shade cacao" = "#A6611A", 
#                                "Sun cacao" = "#DFC27D", 
#                                "Abandoned plantation" = "#80CDC1", 
#                                "Remnant forest" = "#018571")) +
#   theme_minimal() +
#   labs(color = "Land use type") +
#   theme(
#     axis.text = element_text(size = 16),
#     axis.title = element_text(size = 22),
#     legend.text = element_text(size = 16),
#     legend.title = element_text(size = 22)
#   )
# plot_nmds_bray
# #ggsave("output/plot_nmds_bray.png", width = 10, height = 10)
```


#4. Multiple regression for drivers of amphibian abundance and richness

Drivers of site-level species richness and abundance in active plantations
use glmer package to build multiple regression models
- allows for inclusion of both random and fixed effects 

Work at site-level to improve model fit
- At transect-level many sites have only 1-2 species
- Less statistical power at site-level (23 sites), but better understanding of 
  diversity - avoid possibility of pseudoreplication
- Start with the predictor models that were important for transect-level abundance

##a. PCA
- can only work for continuous variables

standard PCA fitting and plotting
```{r}
pca_fit <- prcomp(
  x = site_richness_local[, -c(1,4,5,6,7,10,11,12,16)], # remove these columns
                  scale. = TRUE)

pca_summary <- summary(pca_fit)
pca_summary # first two axes explain 53% of variance

ls(pca_summary) # Lists the objects produced by summary

pca_summary$importance

# biplot - standard, kinda ugly!
biplot(x = pca_fit)
```

fancy biplot with specified colors - need to map manually
```{r}
# Define specific colors
colors <- c("#DFC27D", "#A6611A")
names(colors) <- levels(as.factor(site_richness_local$Tipo))

# Mapping site type abbreviations to full names
site_type_names <- c(C = "Sun cacao", N = "Shade cacao")

# Map colors to points based on Tipo
point_colors <- colors[as.factor(site_richness_local$Tipo)]

# Extract PCA components and loadings
pca_scores <- pca_fit$x  # Observation scores
pca_loadings <- pca_fit$rotation  # Variable loadings

# Create the biplot
plot(pca_scores[, 1], pca_scores[, 2], 
     col = point_colors, 
     pch = 19, 
     xlab = "PC1", 
     ylab = "PC2", 
     main = "Customized PCA Biplot",
     xlim = c(min(c(pca_scores[, 1], pca_loadings[, 1])) * 1.2, 
              max(c(pca_scores[, 1], pca_loadings[, 1])) * 1.2),
     ylim = c(min(c(pca_scores[, 2], pca_loadings[, 2])) * 1.2, 
              max(c(pca_scores[, 2], pca_loadings[, 2])) * 1.2))

# Add arrows for variable loadings
arrows(0, 0, pca_loadings[, 1] * max(abs(pca_scores[, 1])), 
       pca_loadings[, 2] * max(abs(pca_scores[, 2])), 
       length = 0.1, col = "black")

# Add variable labels
text(pca_loadings[, 1] * max(abs(pca_scores[, 1])), 
     pca_loadings[, 2] * max(abs(pca_scores[, 2])), 
     labels = rownames(pca_loadings), 
     col = "black", cex = 0.8)

# Add legend
legend("bottomright", 
       legend = c("Shade", "Sun"), 
       col = c("#A6611A", "#DFC27D"), 
       pch = 19)
```

use ggplot2 for publication level biplot
```{r}
# Prepare data for ggplot
data_pca <- data.frame(PC1 = pca_scores[, 1],
                       PC2 = pca_scores[, 2],
                       Group = as.factor(site_richness_local$Tipo))

loading_data <- data.frame(PC1 = pca_loadings[, 1] * max(abs(pca_scores[, 1])),
                           PC2 = pca_loadings[, 2] * max(abs(pca_scores[, 2])),
                           Variable = rownames(pca_loadings))

# Custom labels for legend
group_labels <- c("C" = "Sun", "N" = "Shade")

# Create plot
site_pca_plot <- ggplot() +
  # Plot points with group coloring
  geom_point(data = data_pca, aes(x = PC1, y = PC2, color = Group), size = 3) +
  # Add arrows for variable loadings
  geom_segment(data = loading_data, aes(x = 0, y = 0, xend = PC1, yend = PC2),
               arrow = arrow(length = unit(0.2, "cm")), color = "black") +
  # Add labels to the arrows
  geom_text_repel(data = loading_data, aes(x = PC1, y = PC2, label = Variable),
                  color = "black", size = 4) +
  # Customize color scale and legend
  scale_color_manual(values = c("#DFC27D", "#A6611A"),
                     labels = group_labels) +
  labs(x = "PC1", y = "PC2", color = "Cacao type") +
  theme_minimal() +
  theme(
    axis.title = element_text(size = 22),
    axis.text = element_text(size = 16),
    legend.title = element_text(size = 22),
    legend.text = element_text(size = 16),
  )

site_pca_plot
#ggsave("output/site_pca_plot.png", width = 10, height = 10)
```

Plot first two axes of PCA, no variable loadings
```{r}
# Define specific colors
colors <- c("#DFC27D", "#A6611A")
names(colors) <- levels(as.factor(site_richness_local$Tipo))

# Mapping site type abbreviations to full names
site_type_names <- c(C = "Sun cacao", N = "Shade cacao")

# Scatterplot with specified colors
plot(x = pca_fit$x[, 1],
     y = pca_fit$x[, 2],
     xlab = "PC 1 (Explained variance: 30%)",
     ylab = "PC 2 (Explained variance: 24%)",
     col = colors[as.factor(site_richness_local$Tipo)],
     pch = 19,
     main = "PCA Scatterplot")

# Add legend with full names
legend("bottomright", 
       legend = site_type_names[levels(as.factor(site_richness_local$Tipo))], 
       col = colors, 
       pch = 19)
```

##b. Correlation

need to address potential variable correlation before building regression models
- site_mean_hoja and site_mean_CC are highly correlated
- so only use one when building models instead of both

visually assess potential correlation of scaled variables in site_richness_local
```{r}
# would only expect local vars or landscape vars to be correlated with each other
ggscatter(site_richness_local, x = "site_mean_hoja_scaled", 
          y = "site_mean_veg_scaled", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "site_mean_hoja_scaled", ylab = "site_mean_veg_scaled")
# r = -.17

ggscatter(site_richness_local, x = "site_mean_hoja_scaled", 
          y = "site_mean_CC_scaled", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "site_mean_hoja_scaled", ylab = "site_mean_CC_scaled")
# r = .79 HIGHLY SCALED

ggscatter(site_richness_local, x = "site_mean_veg_scaled", 
          y = "site_mean_CC_scaled", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "site_mean_veg_scaled", ylab = "site_mean_CC_scaled")
# r = .086

ggscatter(site_richness_local, x = "water_dist_scaled", 
          y = "forest_cover_400_scaled", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "water_dist_scaled", ylab = "forest_cover_400_scaled")
# r = -.41

ggscatter(site_richness_local, x = "water_dist_scaled", 
          y = "elevation_scaled", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "water_dist_scaled", ylab = "elevation_scaled")
# r = -.02

ggscatter(site_richness_local, x = "elevation_scaled", 
          y = "forest_cover_400_scaled", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "elevation_scaled", ylab = "forest_cover_400_scaled")
# r = 0.36
```

confirm this with correlation matrix
- site_mean_CC_scaled and site_mean_hoja_scaled highly correlated (.79)
```{r}
cor(site_richness_local[, c("site_mean_hoja_scaled", 
                             "site_mean_CC_scaled", 
                             "water_dist_scaled", 
                             "forest_cover_400_scaled",
                             "site_mean_veg_scaled",
                             "elevation_scaled")])
```

create pca variable based off CC and hoja b/c highly correlated
- probably just end up using site_mean_hoja_scaled but still keep just in case
```{r}
pca_CC_hoja <- prcomp(site_richness_local
              [, c("site_mean_hoja_scaled", "site_mean_CC_scaled")], scale. = TRUE)
site_richness_local$pca_CC_hoja <- pca_CC_hoja$x[,1]
```


##c. Drivers of site-level amphibian abundance
use glm package to build full multiple regression
- use canopy cover instead of hoja, no quantile deviation detected
- work at site level to avoid pseudoreplication, maintain consistency
- first tried with poisson, but this contained significant overdispersion
- next tried quasipoisson, which better accounts for overdispersion, but over
  dispersion was still extremely high (dispersion parameter = 19.76)
- then tried negative binomial which can better handle extreme overdispersion
- oh no! then we get quantile deviations with this! But there's not much else
  we can do here. Talk with Dr. Tamara Ticktin - this is a result of limited 
  sample size at site-level. Go ahead with negative binomial but present caveat
  that quanitle deviations are detected.

full model - use negative binomial even though quantile deviations detected
- combined adjusted quantile test not significant
```{r}
############# FULL MODEL - !!! quant dev!!! AIC 239.8, CC sig  ##############
# full model with glm.nb, CC, water, forest, veg, elevation, negative binomial
modfull_abundance <- glm.nb(num_ind ~ site_mean_CC_scaled + # use CC not hoja
                   water_dist_scaled +
                   forest_cover_400_scaled +
                   site_mean_veg_scaled +
                   elevation_scaled,
              data = site_richness_local
              )

summary(modfull_abundance) # AIC: 239.8 sig: CC 
vif(modfull_abundance) # vif not a concern
check_overdispersion(modfull_abundance) # not overdispersed (although close)

# assess model fit using dHARMA - quantile deviations detected! quantile test ns
simulationOutput <- simulateResiduals(fittedModel = modfull_abundance)
plot(simulationOutput)

testDispersion(simulationOutput) # not over or under dispersed
testZeroInflation(simulationOutput) # zero inflation not required

# quantile deviation detected when using hoja instead of CC
# model fit errors when using veg as a fixed effect instead of a random effect
# quantile deviation detected when using negative binomial instead of poisson
```

remove terms one at a time 

STEP 1 - start from full model which *HAD QUANTILE DEVIATIONS*, AIC 239.8
```{r}
# STEP 1 - remove one predictor variable

############# MODEL NO CC fits - AIC 240.5 - nothing sig ##############
# model with glm.nb, NO CC, yes water, forest, veg, elevation
mod_abundance_no_CC <- glm.nb(num_ind ~ water_dist_scaled +
                   forest_cover_400_scaled +
                   site_mean_veg_scaled +
                   elevation_scaled,
              data = site_richness_local
              )

summary(mod_abundance_no_CC) # nothing sig, AIC 240.5 (higher)
vif(mod_abundance_no_CC) # vif not a concern
check_overdispersion(mod_abundance_no_CC) # not overdispersed

# assess model fit using dHARMA - no issues here
simulationOutput <- simulateResiduals(fittedModel = mod_abundance_no_CC)
plot(simulationOutput)

testDispersion(simulationOutput) # not over or under dispersed
testZeroInflation(simulationOutput) # zero inflation not required


############# MODEL NO WATER !!! quant dev!!! AIC 237.9, CC sig  ##############
# model with glm.nb, NO water, yes CC, forest, veg, elevation
mod_abundance_no_water <- glm.nb(num_ind ~ site_mean_CC_scaled +
                   forest_cover_400_scaled +
                   site_mean_veg_scaled +
                   elevation_scaled,
              data = site_richness_local
              )

summary(mod_abundance_no_water) # CC sig, AIC 237.9
vif(mod_abundance_no_water) # vif not a concern
check_overdispersion(mod_abundance_no_water) # not overdispersed

# assess model fit using dHARMA - quantile dev detected!
simulationOutput <- simulateResiduals(fittedModel = mod_abundance_no_water)
plot(simulationOutput)

testDispersion(simulationOutput) # not over or under dispersed
testZeroInflation(simulationOutput) # zero inflation not required


############# MODEL NO FOREST !!! quant dev!!! AIC 237.8, CC sig  ##############
# model with glm.nb, NO forest, yes CC, water, veg, elevation
mod_abundance_no_forest <- glm.nb(num_ind ~ site_mean_CC_scaled +
                   water_dist_scaled +
                   site_mean_veg_scaled +
                   elevation_scaled,
              data = site_richness_local
              )

summary(mod_abundance_no_forest) # CC sig, AIC 237.8
vif(mod_abundance_no_forest) # vif not a concern
check_overdispersion(mod_abundance_no_forest) # not overdispersed

# assess model fit using dHARMA - quantile deviations detected!
simulationOutput <- simulateResiduals(fittedModel = mod_abundance_no_forest)
plot(simulationOutput)

testDispersion(simulationOutput) # not over or under dispersed
testZeroInflation(simulationOutput) # zero inflation not required


############# MODEL NO VEG !!! quant dev!!! AIC 238.2, nothing sig  ##############
# model with glm.nb, NO veg, yes CC, water, forest, elevation
mod_abundance_no_veg <- glm.nb(num_ind ~ site_mean_CC_scaled +
                   water_dist_scaled +
                   forest_cover_400_scaled +
                   elevation_scaled,
              data = site_richness_local
              )

summary(mod_abundance_no_veg) # CC sig, AIC 238.2, nothing sig
vif(mod_abundance_no_veg) # vif not a concern
check_overdispersion(mod_abundance_no_veg) # not overdispersed

# assess model fit using dHARMA - quantile deviations detected!
simulationOutput <- simulateResiduals(fittedModel = mod_abundance_no_veg)
plot(simulationOutput)

testDispersion(simulationOutput) # not over or under dispersed
testZeroInflation(simulationOutput) # zero inflation not required


############# MODEL NO ELEVATION FITS -  AIC 239.7, nothing sig  ##############
# model with glm.nb, NO elevation, yes CC, water, forest, veg
mod_abundance_no_elevation <- glm.nb(num_ind ~ site_mean_CC_scaled +
                   water_dist_scaled +
                   forest_cover_400_scaled +
                   site_mean_veg_scaled,
              data = site_richness_local
              )

summary(mod_abundance_no_elevation) # CC sig, AIC 239.7, nothing sig
vif(mod_abundance_no_elevation) # vif not a concern
check_overdispersion(mod_abundance_no_elevation) # not overdispersed

# assess model fit using dHARMA - no issues!
simulationOutput <- simulateResiduals(fittedModel = mod_abundance_no_elevation)
plot(simulationOutput)

testDispersion(simulationOutput) # not over or under dispersed
testZeroInflation(simulationOutput) # zero inflation not required
```

quantile devations detected when CC included in model, only sig term
- so look at how CC and num_ind are interacting - quadratic? doesn't look like it
- continue with using negative binomial despite quantile deviations per
  Dr. Ticktin's advice
```{r}
abundance_CC_plot <- ggplot(site_richness_local, aes(x = site_mean_CC_scaled, 
                                                     y = num_ind)) +
                        geom_point() +
                        geom_smooth()
abundance_CC_plot
# there's just so much variation on such little sample size at site level
# one outlier point may have way too much leverage - DG-C
```


STEP 2
- continue remove terms from simplified no_forest model which *HAD QUANT DEV*
- AIC was 237.8
- systematically remove CC, water, veg, elevation
```{r}
# STEP 2 - remove a second term from no forest model

############# MODEL NO FOREST, NO CC fits - AIC 238.6, nothing sig  ##############
# model with glm.nb, NO forest CC, yes water, veg, elevation
mod_abundance_no_forest_CC <- glm.nb(num_ind ~ water_dist_scaled +
                   site_mean_veg_scaled +
                   elevation_scaled,
              data = site_richness_local
              )

summary(mod_abundance_no_forest_CC) # nothing sig, AIC 238.6
vif(mod_abundance_no_forest_CC) # vif not a concern
check_overdispersion(mod_abundance_no_forest_CC) # not overdispersed

# assess model fit using dHARMA - no issues detected
simulationOutput <- simulateResiduals(fittedModel = mod_abundance_no_forest_CC)
plot(simulationOutput)

testDispersion(simulationOutput) # not over or under dispersed
testZeroInflation(simulationOutput) # zero inflation not required


############# MODEL NO FOREST, NO WATER !!!quant dev!!! - AIC 235.9, CC sig  ##############
# model with glm.nb, NO forest water, yes CC, veg, elevation
mod_abundance_no_forest_water <- glm.nb(num_ind ~ site_mean_CC_scaled +
                   site_mean_veg_scaled +
                   elevation_scaled,
              data = site_richness_local
              )

summary(mod_abundance_no_forest_water) # CC sig, AIC 235.9
vif(mod_abundance_no_forest_water) # vif not a concern
check_overdispersion(mod_abundance_no_forest_water) # not overdispersed

# assess model fit using dHARMA - quant dev detected, quant test n.s.
simulationOutput <- simulateResiduals(
                              fittedModel =  mod_abundance_no_forest_water)
plot(simulationOutput)

testDispersion(simulationOutput) # not over or under dispersed
testZeroInflation(simulationOutput) # zero inflation not required


######### MODEL NO FOREST, NO VEG !!!quant dev!!! - AIC 236.3,  nothing sig  ##########
# model with glm.nb, NO forest veg, yes CC, water, elevation
mod_abundance_no_forest_veg <- glm.nb(num_ind ~ site_mean_CC_scaled +
                   water_dist_scaled +
                   elevation_scaled,
              data = site_richness_local
              )

summary(mod_abundance_no_forest_veg) # nothing sig, AIC 236.3
vif(mod_abundance_no_forest_veg) # vif not a concern
check_overdispersion(mod_abundance_no_forest_veg) # not overdispersed

# assess model fit using dHARMA - quant dev detected, quant test n.s.
simulationOutput <- simulateResiduals(
                              fittedModel =  mod_abundance_no_forest_veg)
plot(simulationOutput)

testDispersion(simulationOutput) # not over or under dispersed
testZeroInflation(simulationOutput) # zero inflation not required


######## MODEL NO FOREST, NO ELEVATION fits - AIC 238.4,  nothing sig  #########
# model with glm.nb, NO forest elevation, yes CC, water, veg
mod_abundance_no_forest_elevation <- glm.nb(num_ind ~ site_mean_CC_scaled +
                   water_dist_scaled +
                   site_mean_veg_scaled,
              data = site_richness_local
              )

summary(mod_abundance_no_forest_elevation) # nothing sig, AIC 238.4
vif(mod_abundance_no_forest_elevation) # vif not a concern
check_overdispersion(mod_abundance_no_forest_elevation) # not overdispersed

# assess model fit using dHARMA - no quant dev detected, quant test n.s.
simulationOutput <- simulateResiduals(
                              fittedModel =  mod_abundance_no_forest_elevation)
plot(simulationOutput)

testDispersion(simulationOutput) # not over or under dispersed
testZeroInflation(simulationOutput) # zero inflation not required
```


STEP 3 
- continue with model no forest, no WATER AIC was 235.9, and it fit!
- now name model for the two remaining components
- systematically remove CC, veg, elevation
```{r}
######## MODEL VEG, ELEVATION !!!quant dev detected!!! - AIC 237.6 , nothing sig  #########
# model with glm.nb, ONLY veg, elevation
mod_abundance_veg_elevation <- glm.nb(num_ind ~ site_mean_veg_scaled +
                                        elevation_scaled,
              data = site_richness_local
              )

summary(mod_abundance_veg_elevation) # nothing sig, AIC 237.6
vif(mod_abundance_veg_elevation) # vif not a concern
check_overdispersion(mod_abundance_veg_elevation) # not overdispersed

# assess model fit using dHARMA - quant dev detected, quant test n.s.
simulationOutput <- simulateResiduals(
                              fittedModel =  mod_abundance_veg_elevation)
plot(simulationOutput)

testDispersion(simulationOutput) # not over or under dispersed
testZeroInflation(simulationOutput) # zero inflation not required


######## MODEL CC, VEG fits - AIC 236.4, nothing sig  #########
# model with glm.nb, ONLY CC, veg
mod_abundance_CC_veg <- glm.nb(num_ind ~ site_mean_CC_scaled +
                   site_mean_veg_scaled,
              data = site_richness_local
              )

summary(mod_abundance_CC_veg) # nothing sig, AIC 236.4
vif(mod_abundance_CC_veg) # vif not a concern
check_overdispersion(mod_abundance_CC_veg) # not overdispersed

# assess model fit using dHARMA - no quant dev detected, quant test n.s.
simulationOutput <- simulateResiduals(
                              fittedModel =  mod_abundance_CC_veg)
plot(simulationOutput)

testDispersion(simulationOutput) # not over or under dispersed
testZeroInflation(simulationOutput) # zero inflation not required


######## MODEL CC, ELEVATION !!!dev detected!!! - 234.3 AIC , CC sig  #########
# model with glm.nb, ONLY CC, ELEVATION
mod_abundance_CC_elevation <- glm.nb(num_ind ~ site_mean_CC_scaled +
                   elevation_scaled,
              data = site_richness_local
              )

summary(mod_abundance_CC_elevation) # CC sig, AIC 234.3
vif(mod_abundance_CC_elevation) # vif not a concern
check_overdispersion(mod_abundance_CC_elevation) # not overdispersed

# assess model fit using dHARMA - quant dev detected, quant test significant
simulationOutput <- simulateResiduals(
                              fittedModel =  mod_abundance_CC_elevation)
plot(simulationOutput)

testDispersion(simulationOutput) # not over or under dispersed
testZeroInflation(simulationOutput) # zero inflation not required
```


STEP 4 
- continue with model CC and ELEVATION AIC was 234.3
- this model had quantile deviations detected, although quantile test was n.s.
- now name model for the single remaining components
- systematically remove CC, elevation
```{r}
######## MODEL CC  fits -  AIC 234.5 , CC not sig  #########
# model with glm.nb, ONLY CC
mod_abundance_CC <- glm.nb(num_ind ~ site_mean_CC_scaled,
              data = site_richness_local
              )

summary(mod_abundance_CC) # nothing sig, AIC 234.5
# vif(mod_abundance_CC) # model contains fewer than 2 terms - so can't
check_overdispersion(mod_abundance_CC) # not overdispersed

# assess model fit using dHARMA - all good!
simulationOutput <- simulateResiduals(
                              fittedModel =  mod_abundance_CC)
plot(simulationOutput)

testDispersion(simulationOutput) # not over or under dispersed
testZeroInflation(simulationOutput) # zero inflation not required


######## MODEL ELEVATION fits  -  AIC 235.8 , elevation not sig  #########
# model with glm.nb, ONLY ELEVATION
mod_abundance_elevation <- glm.nb(num_ind ~ elevation_scaled,
              data = site_richness_local
              )

summary(mod_abundance_elevation) # nothing sig, AIC 235.8
# vif(mod_abundance_elevation) # model contains fewer than 2 terms - so can't
check_overdispersion(mod_abundance_elevation) # not overdispersed

# assess model fit using dHARMA - all good!
simulationOutput <- simulateResiduals(
                              fittedModel =  mod_abundance_elevation)
plot(simulationOutput)

testDispersion(simulationOutput) # not over or under dispersed
testZeroInflation(simulationOutput) # zero inflation not required
```


STOP
- abundance model with CC and elevation has the lowest AIC value
- canopy cover has a significant positive correlation with amphibian abundance
- elevation does not have a significant effect in this model
- note that quantile deviations were detected, but quantile test was not significant
- interpretation: CC and highly correlated leaf litter have a significant positive
  correlation with amphibian abundance. but note that these models contained
  quantile deviations


##d. Drivers of site-level amphibian richness
use glm package to build full multiple regression
- inclusion of random effects produced singular fit errors with glmer
- use canopy cover instead of hoja b/c highly correlated
- model needs to be simplified b/c less power and replication at site-level
- work at site level b/c trans level richness counts are not as meaningful
- start with full model, then systematically remove one term, compare AIC values
  until minima is reached


FULL MODEL
```{r}
############# FULL MODEL fits - nothing sig - AIC 103.2 ##############
# full model with glm, no R.E., poisson
mod_richness_full <- glm(no_species ~ site_mean_CC_scaled +
                                    site_mean_veg_scaled +
                                    water_dist_scaled +
                                    forest_cover_400_scaled +
                                    elevation_scaled,
                                    data = site_richness_local,
                                    family = poisson())

summary(mod_richness_full) # nothing sig - AIC 103.2
vif(mod_richness_full) # VIF not concern
check_overdispersion(mod_richness_full) # not over dispersed

# assess model fit using dHARMA - no issues!
simulationOutput <- simulateResiduals(fittedModel = mod_richness_full)
plot(simulationOutput)

testDispersion(simulationOutput) # not over dispersed
testZeroInflation(simulationOutput) # not zero inflated
```


STEP 1
- start from full model which confirmed fit model assumptions
- full model AIC was 103.2
- systematically remove CC, veg, water, forest, elevation
```{r}
############# FULL MODEL NO CC !!!quant test sig!!!- AIC 101.2 - nothing sig ##############
# full model with glm, veg, water, forest, elevation, no CC, no R.E., poisson
mod_richness_full_no_CC <- glm(no_species ~ site_mean_veg_scaled +
                                    water_dist_scaled +
                                    forest_cover_400_scaled +
                                    elevation_scaled,
                                    data = site_richness_local,
                                    family = poisson())

summary(mod_richness_full_no_CC) # nothing sig - AIC 101.2
vif(mod_richness_full_no_CC) # vif not a concern
check_overdispersion(mod_richness_full_no_CC) # not overdispersed

# assess model fit using dHARMA - !!!quant dev detected, quant test sig!!!
simulationOutput <- simulateResiduals(fittedModel = mod_richness_full_no_CC)
plot(simulationOutput)

testDispersion(simulationOutput) # not over dispersed
testZeroInflation(simulationOutput) # not zero inflated


############# FULL MODEL NO VEG fits - AIC 101.2 - nothing sig ##############
# full model with glm, CC, water, forest, elevation, no veg, no R.E., poisson
mod_richness_full_no_veg <- glm(no_species ~ 
                                    site_mean_CC_scaled +
                                    water_dist_scaled +
                                    forest_cover_400_scaled +
                                    elevation_scaled,
                                    data = site_richness_local,
                                    family = poisson())

summary(mod_richness_full_no_veg) # nothing sig - AIC 101.2
vif(mod_richness_full_no_veg) # vif not a concern
check_overdispersion(mod_richness_full_no_veg) # not overdispersed

# assess model fit using dHARMA - no issues!
simulationOutput <- simulateResiduals(fittedModel = mod_richness_full_no_veg)
plot(simulationOutput)

testDispersion(simulationOutput) # not over dispersed
testZeroInflation(simulationOutput) # not zero inflated


#### FULL MODEL NO WATER !!!quant dev detected, test n.s.!!! AIC 101.4, nothing sig ###
# full model with glm, CC, veg, forest, elevation, no water, no R.E., poisson
mod_richness_full_no_water <- glm(no_species ~ 
                                    site_mean_CC_scaled +
                                    site_mean_veg_scaled +
                                    forest_cover_400_scaled +
                                    elevation_scaled,
                                    data = site_richness_local,
                                    family = poisson())

summary(mod_richness_full_no_water) # nothing sig - AIC 101.4
vif(mod_richness_full_no_water) # vif not a concern
check_overdispersion(mod_richness_full_no_water) # not overdispersed

# assess model fit using dHARMA - QUANTILE DEVIATIONS DETECTED - test n.s.
simulationOutput <- simulateResiduals(fittedModel = mod_richness_full_no_water)
plot(simulationOutput)

testDispersion(simulationOutput) # not over dispersed
testZeroInflation(simulationOutput) # not zero inflated


############# FULL MODEL NO FOREST fits - nothing sig - AIC 101.7 ##############
# full model with glm, CC, veg, water, elevation, no forest, no R.E., poisson
mod_richness_full_no_forest <- glm(no_species ~ 
                                    site_mean_CC_scaled +
                                    site_mean_veg_scaled +
                                    water_dist_scaled +
                                    elevation_scaled,
                                    data = site_richness_local,
                                    family = poisson())


summary(mod_richness_full_no_forest) # nothing sig - AIC 101.7
vif(mod_richness_full_no_forest) # vif not a concern
check_overdispersion(mod_richness_full_no_forest) # not overdispersed

# assess model fit using dHARMA - no issues!
simulationOutput <- simulateResiduals(fittedModel = mod_richness_full_no_forest)
plot(simulationOutput)

testDispersion(simulationOutput) # not over dispersed
testZeroInflation(simulationOutput) # not zero inflated

###### FULL MODEL NO ELEVATION !!!quant dev, test n.s.!!! AIC 102.8, nothing sig ######
# full model with glm, CC, veg, water, forest no elevation, no R.E., poisson
mod_richness_full_no_elevation <- glm(no_species ~ 
                                    site_mean_CC_scaled +
                                    site_mean_veg_scaled +
                                    water_dist_scaled +
                                    forest_cover_400_scaled,
                                    data = site_richness_local,
                                    family = poisson())

summary(mod_richness_full_no_elevation) # nothing sig - AIC 102.8
vif(mod_richness_full_no_elevation) # vif not a concern
check_overdispersion(mod_richness_full_no_elevation) # not overdispersed

# assess model fit using dHARMA - !!!QUANTILE DEVIATIONS DETECTED (quantile test n.s.)!!!
simulationOutput <- simulateResiduals(fittedModel = mod_richness_full_no_elevation)
plot(simulationOutput)

testDispersion(simulationOutput) # not over dispersed
testZeroInflation(simulationOutput) # not zero inflated
```


STEP 2
- continue with no veg model, AIC 101.2, and it fit!
- no CC model has had AIC 101.2, but quant dev detecetd
- continue removing remaining terms (CC, water, forest, elevation) systematically
```{r}
############# MODEL NO VEG, CC fits, AIC 99.2, nothing sig ##############
# model with water, forest, elevation, without veg, CC, glm, no R.E., poisson
mod_richness_no_veg_CC <- glm(no_species ~  water_dist_scaled +
                                    forest_cover_400_scaled +
                                    elevation_scaled,
                                    data = site_richness_local,
                                    family = poisson())

summary(mod_richness_no_veg_CC) # nothing sig - AIC 99.2
vif(mod_richness_no_veg_CC) # vif not a concern
check_overdispersion(mod_richness_no_veg_CC) # not overdispersed

# assess model fit using dHARMA - no issues!
simulationOutput <- simulateResiduals(fittedModel = mod_richness_no_veg_CC)
plot(simulationOutput)

testDispersion(simulationOutput) # not over dispersed
testZeroInflation(simulationOutput) # not zero inflated


############# MODEL NO VEG, WATER fits, AIC 99.4, nothing sig ##############
# model with CC, forest, elevation, without veg, water, glm, no R.E., poisson
mod_richness_no_veg_water <- glm(no_species ~ 
                                    site_mean_CC_scaled +
                                    forest_cover_400_scaled +
                                    elevation_scaled,
                                    data = site_richness_local,
                                    family = poisson())

summary(mod_richness_no_veg_water) # nothing sig - AIC 99.4
vif(mod_richness_no_veg_water) # vif not a concern
check_overdispersion(mod_richness_no_veg_water) # not overdispersed

# assess model fit using dHARMA - no issues!
simulationOutput <- simulateResiduals(fittedModel = mod_richness_no_veg_water)
plot(simulationOutput)

testDispersion(simulationOutput) # not over dispersed
testZeroInflation(simulationOutput) # not zero inflated


############# MODEL NO VEG, FOREST fits, AIC 99.8, nothing sig ##############
# model with CC, water, elevation, without veg, forest, glm, no R.E., poisson
mod_richness_no_veg_forest <- glm(no_species ~ 
                                    site_mean_CC_scaled +
                                    water_dist_scaled +
                                    elevation_scaled,
                                    data = site_richness_local,
                                    family = poisson())

summary(mod_richness_no_veg_forest) # nothing sig - AIC 99.8
vif(mod_richness_no_veg_forest) # vif not a concern
check_overdispersion(mod_richness_no_veg_forest) # not overdispersed

# assess model fit using dHARMA - no issues!
simulationOutput <- simulateResiduals(fittedModel = mod_richness_no_veg_forest)
plot(simulationOutput)

testDispersion(simulationOutput) # not over dispersed
testZeroInflation(simulationOutput) # not zero inflated


############# MODEL NO VEG, ELEVATION fits, AIC 100.9, nothing sig ##############
# model with CC, water, forest, without veg, elevation, glm, no R.E., poisson
mod_richness_no_veg_elevation <- glm(no_species ~ 
                                    site_mean_CC_scaled +
                                    water_dist_scaled +
                                    forest_cover_400_scaled,
                                    data = site_richness_local,
                                    family = poisson())

summary(mod_richness_no_veg_elevation) # nothing sig - AIC 101.04
vif(mod_richness_no_veg_elevation) # vif not a concern
check_overdispersion(mod_richness_no_veg_elevation) # not overdispersed

# assess model fit using dHARMA - no issues!
simulationOutput <- simulateResiduals(fittedModel = mod_richness_no_veg_elevation)
plot(simulationOutput)

testDispersion(simulationOutput) # not over dispersed
testZeroInflation(simulationOutput) # not zero inflated
```


STEP 3
- continue with no veg, no CC model - AIC was 99.2
- continue removing terms systematically (water, forest, elevation)
- name model for remaining terms now
```{r}
############# MODEL FOREST, ELEVATION fits , AIC 97.4 , nothing sig ##############
# model with forest, elevation, without veg, CC, water, glm, no R.E., poisson
mod_richness_forest_elevation <- glm(no_species ~ forest_cover_400_scaled +
                                    elevation_scaled,
                                    data = site_richness_local,
                                    family = poisson())

summary(mod_richness_forest_elevation) # nothing sig - AIC 97.4
vif(mod_richness_forest_elevation) # vif not a concern
check_overdispersion(mod_richness_forest_elevation) # not overdispersed

# assess model fit using dHARMA - no issues!
simulationOutput <- simulateResiduals(fittedModel = mod_richness_forest_elevation)
plot(simulationOutput)

testDispersion(simulationOutput) # not over dispersed
testZeroInflation(simulationOutput) # not zero inflated


############# MODEL FOREST, WATER fits , AIC 99.2 , nothing sig ##############
# model with forest, water, without veg, CC, elevation, glm, no R.E., poisson
mod_richness_forest_water <- glm(no_species ~ forest_cover_400_scaled +
                                    water_dist_scaled,
                                    data = site_richness_local,
                                    family = poisson())

summary(mod_richness_forest_water) # nothing sig - AIC 99.2
vif(mod_richness_forest_water) # vif not a concern
check_overdispersion(mod_richness_forest_water) # not overdispersed

# assess model fit using dHARMA - no issues!
simulationOutput <- simulateResiduals(fittedModel = mod_richness_forest_water)
plot(simulationOutput)

testDispersion(simulationOutput) # not over dispersed
testZeroInflation(simulationOutput) # not zero inflated


############# MODEL ELEVATION, WATER fits , AIC 97.9 , nothing  sig ##############
# model with elevation, water, without veg, CC, forest, glm, no R.E., poisson
mod_richness_elevation_water <- glm(no_species ~ elevation_scaled +
                                    water_dist_scaled,
                                    data = site_richness_local,
                                    family = poisson())

summary(mod_richness_elevation_water) # nothing sig - AIC 97.9
vif(mod_richness_elevation_water) # vif not a concern
check_overdispersion(mod_richness_elevation_water) # not overdispersed

# assess model fit using dHARMA - no issues!
simulationOutput <- simulateResiduals(fittedModel = mod_richness_elevation_water)
plot(simulationOutput)

testDispersion(simulationOutput) # not over dispersed
testZeroInflation(simulationOutput) # not zero inflated
```


STEP 4
- continue with forest, elevation model - AIC was 97.4
- continue removing terms systematically (forest, elevation)
- name model for remaining term
```{r}
############# MODEL FOREST , AIC 97.2  , nothing sig ##############
# model with only forest, without veg, CC, water, elevation, glm, no R.E., poisson
mod_richness_forest <- glm(no_species ~ forest_cover_400_scaled,
                                    data = site_richness_local,
                                    family = poisson())

summary(mod_richness_forest) # not sig - AIC 97.2
#vif(mod_richness_forest) # model contains fewer than 2 terms
check_overdispersion(mod_richness_forest) # not overdispersed

# assess model fit using dHARMA - no issues!
simulationOutput <- simulateResiduals(fittedModel = mod_richness_forest)
plot(simulationOutput)

testDispersion(simulationOutput) # not over dispersed
testZeroInflation(simulationOutput) # not zero inflated\


############# MODEL ELEVATION fits , AIC 95.9 , nothing sig ##############
# model with only elevation, without veg, CC, water, forest, glm, no R.E., poisson
mod_richness_elevation <- glm(no_species ~ elevation_scaled,
                                    data = site_richness_local,
                                    family = poisson())

summary(mod_richness_elevation) # nothing sig - AIC 95.9
#vif(mod_richness_elevation) # model contains fewer than 2 terms
check_overdispersion(mod_richness_elevation) # not overdispersed

# assess model fit using dHARMA - no issues!
simulationOutput <- simulateResiduals(fittedModel = mod_richness_elevation)
plot(simulationOutput)

testDispersion(simulationOutput) # not over dispersed
testZeroInflation(simulationOutput) # not zero inflated
```


STOP
- nothing left to remove
- richness model only elevation has the lowest AIC value
- elevation does not have a significant effect in this model
- interpretation: our environmental variables do not adequately explain richness


#6. P. achatinus exclusive analysis

##a. Priach percentage visualization
- How does abundance, percentage vary across habitat types?
```{r}
# site_labels here includes all 4 site types b/c comparing percentages
site_labels <-  c("Shade Cacao \n (n = 12)", 
                  "Sun Cacao \n (n = 11)", 
                  "Abandoned Plantation \n (n = 4)",
                  "Remnant Forest \n (n = 5)")

# reorder factor levels
priach_by_site$Tipo <- factor(priach_by_site$Tipo,
                         c("N", "C", "V", "B"))

# plot P. achatinus across landuse types using palet, my_theme
plot_priach_by_site <- ggplot(priach_by_site, 
                                     aes(x = Tipo, y = priach_percentage, 
                                         fill = Tipo)) +
  geom_boxplot() +
  scale_fill_manual(values = pal) + # order needs to match factor levels above
  scale_x_discrete(labels = c(site_labels)) +
  my_theme() + 
  labs(x = "Land use type",
       y = "P. achatinus percentage of total captures")
plot_priach_by_site

#ggsave("output/plot_priach_by_site.png", width = 10, height = 10)
```


##b. Priach percentage Kruskal-Wallis across landuse types
- use Kruskal-Wallis b/c ANOVA residuals not normally distributed
- there is no statistically sig difference in priach % between landuse types
```{r}
# ANOVA residuals are not normally distributed
######################################################
# create ANOVA
priach_percentage_aov <- aov(priach_percentage ~ Tipo,
  data = priach_by_site
)
# visually check ANOVA assumption of normality of residuals
par(mfrow = c(1, 2)) # combine plots
# histogram
hist(priach_percentage_aov$residuals)
# QQ-plot
qqPlot(priach_percentage_aov$residuals,
  id = FALSE # id = FALSE to remove point identification
)
# shapiro test for normality - ANOVA is NOT NORMALLY DISTRIBUTED
shapiro.test(priach_percentage_aov$residuals)
######################################################

# so instead use Kruskal-Wallis test b/c doesn't require normality assumptions
priach_percentage_kruskal <- kruskal.test(priach_percentage ~ Tipo, 
                                          data = priach_by_site)
priach_percentage_kruskal
# No significant difference in priach percentage between landuse types
```


#7. Analyses without P. achatinus


Quickly run subset of analyses to see if removing priach changes findings
- is priach driving abundance and (lack of) species richness patterns?

comparing richness and abundance of active cacao sites
```{r}
# richness in cacao no priach
test_plot <- ggplot(site_richness_local_no_priach, 
                                     aes(x = Tipo, y = no_species, fill = Tipo)) +
  geom_boxplot() +
 # scale_fill_manual(values = pal) + # order needs to match factor levels above
  #scale_x_discrete(labels = c(site_labels)) +
  my_theme() + 
  labs(x = "Land use type",
       y = "Non priach Species richness")
test_plot

# abundance in cacao no priach
test_2 <- ggplot(site_richness_local_no_priach, 
                                     aes(x = Tipo, y = num_ind, fill = Tipo)) +
  geom_boxplot() +
  my_theme() + 
  labs(x = "Land use type",
       y = "Num non priach ind")
test_2
```

doesn't appear to be any change in biplot
```{r}
# Define specific colors
colors <- c("#DFC27D", "#A6611A")
names(colors) <- levels(as.factor(site_richness_local_no_priach$Tipo))

# Mapping site type abbreviations to full names
site_type_names <- c(C = "Sun cacao", N = "Shade cacao")

# Map colors to points based on Tipo
point_colors <- colors[as.factor(site_richness_local_no_priach$Tipo)]

# Extract PCA components and loadings
pca_scores <- pca_fit$x  # Observation scores
pca_loadings <- pca_fit$rotation  # Variable loadings

# Create the biplot
plot(pca_scores[, 1], pca_scores[, 2], 
     col = point_colors, 
     pch = 19, 
     xlab = "PC1", 
     ylab = "PC2", 
     main = "Customized PCA Biplot",
     xlim = c(min(c(pca_scores[, 1], pca_loadings[, 1])) * 1.2, 
              max(c(pca_scores[, 1], pca_loadings[, 1])) * 1.2),
     ylim = c(min(c(pca_scores[, 2], pca_loadings[, 2])) * 1.2, 
              max(c(pca_scores[, 2], pca_loadings[, 2])) * 1.2))

# Add arrows for variable loadings
arrows(0, 0, pca_loadings[, 1] * max(abs(pca_scores[, 1])), 
       pca_loadings[, 2] * max(abs(pca_scores[, 2])), 
       length = 0.1, col = "black")

# Add variable labels
text(pca_loadings[, 1] * max(abs(pca_scores[, 1])), 
     pca_loadings[, 2] * max(abs(pca_scores[, 2])), 
     labels = rownames(pca_loadings), 
     col = "black", cex = 0.8)

# Add legend
legend("bottomright", 
       legend = c("Shade", "Sun"), 
       col = c("#A6611A", "#DFC27D"), 
       pch = 19)
```

glmer of site richness without priach shows no difference
```{r}
mod_richness_full_no_priach <- glm(no_species ~ site_mean_CC_scaled +
                                    site_mean_veg_scaled +
                                    water_dist_scaled +
                                    forest_cover_400_scaled +
                                    Elevation,
                                    data = site_richness_local_no_priach,
                                    family = poisson())

summary(mod_richness_full_no_priach) # nothing sig - AIC 101.11
vif(mod_richness_full_no_priach) # VIF not concern
check_overdispersion(mod_richness_full_no_priach) # not over dispersed

# assess model fit using dHARMA - no issues!
simulationOutput <- simulateResiduals(fittedModel = mod_richness_full_no_priach)
plot(simulationOutput)

testDispersion(simulationOutput) # not over dispersed
testZeroInflation(simulationOutput) # not zero inflated
############# FULL MODEL - nothing sig - AIC 103.5 ##############
```


# 8. Species list

```{r}
new %>%
  group_by(Final_ID) %>%
  summarize(n = n())

new %>%
  group_by(Final_ID, Tipo) %>%
  summarize(n = n())
```


# 9. Variation of environmental variables across sites and site types

This is important to see if shade cacao sites are really shaded etc.
Or, is there so much variation within these sites that they're not ecologically
distinct?

visualize distributions
```{r}
site_richness_local_all$Tipo <- factor(site_richness_local_all$Tipo,
                         c("N", "C", "V", "B"))

# canopy cover
canopy_hist <- ggplot(site_richness_local_all, 
                      aes(x = site_mean_CC, fill = Tipo)) +
  geom_histogram() +
  scale_fill_manual(values = pal)
canopy_hist

# hoja
hoja_hist <- ggplot(site_richness_local_all, 
                    aes(x = site_mean_hoja, fill = Tipo)) +
  geom_histogram() +
  scale_fill_manual(values = pal)
hoja_hist

# forest
forest_hist <- ggplot(site_richness_local_all, 
                      aes(x = forest_cover_400, fill = Tipo)) +
  geom_histogram() +
  scale_fill_manual(values = pal)
forest_hist

# water
water_hist <- ggplot(site_richness_local_all, 
                     aes(x = water_dist, fill = Tipo)) +
  geom_histogram() +
  scale_fill_manual(values = pal)
water_hist

# veg
veg_hist <- ggplot(site_richness_local_all, 
                   aes(x = site_mean_veg, fill = Tipo)) +
  geom_histogram() +
  scale_fill_manual(values = pal)
veg_hist

# elevation
elevation_hist <- ggplot(site_richness_local_all, 
                         aes(x = Elevation, fill = Tipo)) +
  geom_histogram() +
  scale_fill_manual(values = pal)
elevation_hist
```

arrange hist for publication as supplementary material
```{r}
hist_arrange <- ggarrange(
  canopy_hist,
  hoja_hist,
  forest_hist,
  water_hist,
  veg_hist,
  elevation_hist
)
hist_arrange

#ggsave("output/hist_arrange_variables.png", width = 15, height = 10)
```


make a supplementary table showing type level means
- important to show spread of these variables
```{r}
env_table <- site_richness_local_all %>%
  group_by(Tipo) %>%
  summarise(mean_canopy = mean(site_mean_CC), 
            sd_canopy = sd(site_mean_CC),
            mean_hoja = mean(site_mean_hoja), 
            sd_hoja = sd(site_mean_hoja),
            mean_forest = mean(forest_cover_400), 
            sd_forest = sd(forest_cover_400),
            mean_water = mean(water_dist), 
            sd_water = sd(water_dist),
            mean_veg = mean(site_mean_veg), 
            sd_veg = sd(site_mean_veg),
            mean_elevation = mean(Elevation), 
            sd_elevation = sd(Elevation),
            ) 

# write.csv(env_table, "output/env_table.csv", row.names = FALSE)
```
