
# PROCESSING DATA

Use this script to perform small tasks on raw data to make it tidier, 
easier to work with. Output is processed data to be used in analysis scripts.


# load packages
```{r}
library(tidyverse)
library(vegan)
library(labdsv)
```

define file path for processed outputs
```{r}
# this will be consistent for each output in this script
data_dir <- file.path(".", "data/processed_data")
```


# ranas

ranas - individual occurrence data across all sites
```{r}
# read raw ranas data
ranas <- read_csv("data/raw_data/ranas_03_26_24.csv")

# format dates
ranas$sample_date <- as.Date(ranas$Fecha, format = "%d/%m/%y")

# need to change VC-V to VC-N, turns out this site was not actually abandoned!
ranas <- ranas %>%
  mutate(Sitio = replace(Sitio, Sitio == "VC-V", "VC-N"),
         year = substr(sample_date, 1, 4))

# remove '..20' column - not sure why these are being added
ranas <- ranas %>%
  select(-...20)

ranas$Tipo[ranas$Sitio == "VC-N"] <- "N"

# make processed csv output
filename <- "ranas_processed.csv"
filepath <- file.path(data_dir, filename)

# write df to csv
write_csv(ranas, file = filepath)
```


# new

new - only new individuals from ranas dataset
```{r}
# make new with only new ind
new <- ranas %>%
  filter(Recap == "N")

# output
filename <- "new_processed.csv"
filepath <- file.path(data_dir, filename)
write_csv(new, file = filepath)
```


# environmental

environmental - environmental data for each sampling event
```{r}
# environmental data - change VC-V to VC-N
environmental <- read_csv("data/raw_data/environment_04_08_23.csv")

environmental$sample_date <- as.Date(environmental$Fecha, format = "%d/%m/%y")

# update VC-N
environmental <- environmental %>%
  mutate(Sitio = replace(Sitio, Sitio == "VC-V", "VC-N"))

environmental$Tipo[environmental$Sitio == "VC-N"] <- "N"

# output
filename <- "environmental_processed.csv"
filepath <- file.path(data_dir, filename)
write_csv(environmental, file = filepath)
```


# site_data

site_data - location, canopy cover, and miscellaneous data for each site
```{r}
# site_data - change VC-V to VC-N
site_data <- read_csv("data/raw_data/site_data_03_26_24.csv")

# update VC-N
site_data <- site_data %>%
  mutate(Sitio = replace(Sitio, Sitio == "VC-V", "VC-N"))

site_data$Tipo[site_data$Sitio == "VC-N"] <- "N"

# output
filename <- "site_data_processed.csv"
filepath <- file.path(data_dir, filename)
write_csv(site_data, file = filepath)
```


# site_type

site_type - retains elevation, tipo data
```{r}
site_type <- site_data %>% # create site_type df - include name, elevation
  filter(Transecto == 1) %>% # so just one row per site
  select(Sitio, Tipo, Elevation)

# reorder factor levels now for downstream plotting
site_type$Tipo <- factor(site_type$Tipo, c("N", "C", "V", "B"))

# here add harvested column for later analyses
site_type <- site_type %>%
  mutate(harvested = case_when(
    Tipo == "N" ~ "Yes",
    Tipo == "C" ~ "Yes",
    Tipo == "B" ~ "No",
    Tipo == "V" ~ "No")
    )

# output
filename <- "site_type_processed.csv"
filepath <- file.path(data_dir, filename)
write_csv(site_type, file = filepath)
```


# richness_by_site
richness by site - just number of species
```{r}
# group by site
richness_by_site <- new %>%
  group_by(Sitio) %>%
  summarize(species = list(sort(unique(`Final_ID`))),
            no_species = n_distinct(`Final_ID`))

# join with site_type to carry over tipo, elevation, harvested info
richness_by_site <- richness_by_site %>%
  left_join(site_type, by = "Sitio")

# Group by land_use and calculate species richness
richness_summary <- richness_by_site %>%
  group_by(Tipo) %>%
  summarize(mean_species_richness = mean(no_species),
            median_species_richness = median(no_species),
            min_species_richness = min(no_species),
            max_species_richness = max(no_species))

# output
filename <- "richness_by_site_processed.csv"
filepath <- file.path(data_dir, filename)
write_csv(richness_by_site, file = filepath)
```


# abundance_by_site

just number of ind
```{r}
# note this is same as site_abundance above
abundance_by_site <- new %>%
  group_by(Sitio) %>%
  count()

# join with site_type to carry over tipo, elevation, harvested info
abundance_by_site <- abundance_by_site %>%
  left_join(site_type, by = "Sitio")

abundance_by_site$Tipo <- factor(abundance_by_site$Tipo, c("N", "C", "V", "B"))

# output
filename <- "abundance_by_site_processed.csv"
filepath <- file.path(data_dir, filename)
write_csv(abundance_by_site, file = filepath)
```


# diversity_by_site

use 3 column format to get diversity indices for each site using vegan package

diversity_by_site - each major diversity metric
```{r}
# use diversity function from vegan package
diversity_by_site <- site_type %>%
    mutate(Shannon_Index = diversity(new_mat, index = "shannon")) %>%
    mutate(Simpson_Index = diversity(new_mat, index = "simpson")) %>%
    mutate(Inv_Simpson_Index = diversity(new_mat, index = "invsimpson"))

# output
filename <- "diversity_by_site_processed.csv"
filepath <- file.path(data_dir, filename)
write_csv(diversity_by_site, file = filepath)
```












