---
title: "Ranas_compare"
author: "S. Holden Jones"
date: "3/6/24"
output: word_document
---

# COMPARE RICHNESS, ABUNDANCE, DIVERSITY, COMPOSITION ACROSS LANDUSE TYPES

This script will take processed data as input, run statistic tests and produce
figures comparing the dependent variables (diversity, abundance, composition) of
each landuse type broadly. Other scripts will explore the variation in these
response variables w/in specific landuse types.


--------------------------------------------------------------------------------
--------------------------------------------------------------------------------


load packages
```{r, include=FALSE}
library(labdsv)
library(tidyverse)
library(vegan)
library(RColorBrewer)
```

load data
## weird that dfs are of different lengths, why are columns getting added randomly?. Also note that ranas is a tbl_df and new is spec_tbl_df despite being created from ranas

```{r, include=FALSE}
ranas <- read_csv("data/processed_data/ranas_processed.csv")

# remove '...1' column - not sure why this is being added
ranas <- ranas %>%
  select(-...1)

new <- read_csv("data/processed_data/new_processed.csv")

site_data <- read_csv("data/processed_data/site_data_processed.csv")
```

define a consistent palet, labels, and theme to be used in multiple figures
## still would be nice to have palet for harvested comparison
```{r}
# palet for comparisons of all 4 site types
pal <- brewer.pal(4, "BrBG")

# site labels for 4 site comparison, use in several plots
site_labels <-  c("Shade \n (n = 12)", "Sun \n (n = 11)", 
                              "Abandoned \n (n = 4)", "Forest \n (n = 5)")

# site labels for harvest, non-harvest comparison
labels_harvest <-  c("Not harvested \n (n = 9)", "Harvested \n (n = 23)")

# set a theme for ggplots
my_theme <- function() {
  theme_minimal() + 
   theme(legend.position = "none",
        plot.background = element_rect("white"),
        panel.background = element_rect("white"),
        panel.grid = element_line("grey90"),
        axis.line = element_line("gray25"),
        axis.text = element_text(size = 12, color = "gray25"),
        axis.title = element_text(size = 14, color = "gray25"),
        legend.text = element_text(size = 12))
}
```



--------------------------------------------------------------------------------
--------------------------------------------------------------------------------


# RICHNESS ACROSS LANDUSE TYPES

richness by type - just number of species

## sig difference in species richness across landuse types
- although B, V are higher!
```{r}
# group by site and type to retain type for ggplot
richness_by_site <- new %>%
  group_by(Sitio, Tipo) %>%
  summarize(species = list(sort(unique(`Final_ID`))),
            no_species = n_distinct(`Final_ID`))

# Group by land_use and calculate species richness
richness_summary <- richness_by_site %>%
  group_by(Tipo) %>%
  summarize(mean_species_richness = mean(no_species),
            median_species_richness = median(no_species),
            min_species_richness = min(no_species),
            max_species_richness = max(no_species))
```

run ANOVA on species richness across the 4 landuse types
- p-value: 0.0372
```{r}
aov_richness <- aov(no_species ~ Tipo, data = richness_by_site)

summary(aov_richness)
```

plot species richness across landuse types
```{r}
# reorder factor levels
richness_by_site$Tipo <- factor(richness_by_site$Tipo,
                         c("N", "C", "V", "B"))

# plot species richness across landuse types using palet, my_theme
plot_richness_by_site <- ggplot(richness_by_site, 
                                     aes(x = Tipo, y = no_species, fill = Tipo)) +
  geom_boxplot() +
  scale_fill_manual(values = pal) +
  # order needs to match factor levels above
  scale_x_discrete(labels = c(site_labels)) +
  my_theme() + 
  labs(x = "Landuse types",
       y = "Species richness",
       title = "Species richness across landuse types")

plot_richness_by_site
```


--------------------------------------------------------------------------------
# Harvested vs. non-harvested for richness

AOV sp. richness against harvested, non-harvested
- highly sig!
```{r}
# add harvested column
richness_by_site <- richness_by_site %>%
  mutate(harvested = case_when(
    Tipo == "N" ~ "Yes",
    Tipo == "C" ~ "Yes",
    Tipo == "B" ~ "No",
    Tipo == "V" ~ "No")
    )

# then run aov here
aov_richness_harvest <- aov(no_species ~ harvested, data = richness_by_site)

summary(aov_richness_harvest)
```

B+V have sig higher richness than N+C
## aesthetically would want to mix colors from previous plot
```{r}
# plot
plot_richness_by_harvest <- ggplot(richness_by_site, 
                                   aes(x = harvested, y = no_species, fill = harvested)) +
  scale_x_discrete(labels = c(labels_harvest)) +
  geom_boxplot() +
  my_theme() +
  labs(x = "Active cacao plantation?", y = "Species richness") +
  ggtitle("Species richness in harvested and non-harvested areas")
plot_richness_by_harvest
```


--------------------------------------------------------------------------------
--------------------------------------------------------------------------------


# ABUNDANCE ACROSS LANDUSE TYPES

number of new individuals 
## could eventually complicate this to look at pop size estimates?


anova for abundance
- not sig
```{r}
abundance_by_site <- new %>%
  group_by(Sitio, Tipo) %>%
  count()

abundance_by_site$Tipo <- factor(abundance_by_site$Tipo, c("N", "C", "V", "B"))

aov_abundance <- aov(n ~ Tipo, data = abundance_by_site)
summary(aov_abundance)
```


```{r}
plot_abundance_by_site <- ggplot(abundance_by_site, aes(x = Tipo, y = n, fill = Tipo)) +
  geom_boxplot() +
  scale_fill_manual(values = pal) +
  scale_x_discrete(labels = c(site_labels)) +
  my_theme() +
  labs(x = "Landuse type",
       y = "Individuals per site",
       title = "Abundance across landuse types")
plot_abundance_by_site
```

anova for abundance
## abundance differences are not statistically significant
```{r}
aov_abundance <- aov(n ~ Tipo, data = abundance_by_site)
summary(aov_abundance)
```


--------------------------------------------------------------------------------
--------------------------------------------------------------------------------


# DIVERSITY ACROSS LANDUSE TYPES

Look at how different diversity metrics compare across landuse types

# First need to convert data into 3 column format
habitat, species, abundance for labdsv - use matrify!

new_mat - three column format to use in labdsv package
```{r}
three_column <- new %>%
  group_by(Sitio) %>%
  count(`Final_ID`)

# needs to be converted to data.frame!
three_column <- data.frame(three_column)

new_mat <- matrify(three_column)
```


--------------------------------------------------------------------------------
# Diversity Indices

# Wonderful tutorials!
https://peat-clark.github.io/BIO381/veganTutorial.html
https://www.youtube.com/watch?v=wq1SXGQYgCs

use 3 column format to get diversity indices for each site!
```{r}
print(shannon <- diversity(new_mat, index = "shannon"))
print(simpson <- diversity(new_mat, index = "simpson"))
print(inv_simpson <- diversity(new_mat, index = "invsimpson"))
```

compare these indices with histograms
```{r}
par(mfrow = c(1, 2))  # use par to generate panels with 1 row of 2 graphs
hist(simpson)
hist(shannon)
```


--------------------------------------------------------------------------------
# dataframe creation here to run statistical tests

create site_type df and join to enframed shannon_df
```{r}
# create site_type df, just name of site and the type
site_type <- site_data %>%
  filter(Transecto == 1) %>% # so just one row per site
  select(Sitio, Tipo)

# reorder factor levels now for downstream plotting
site_type$Tipo <- factor(site_type$Tipo, c("N", "C", "V", "B"))

# here add harvested column for later analyses
site_type <- site_type %>%
  mutate(harvested = case_when(
    Tipo == "N" ~ "Yes",
    Tipo == "C" ~ "Yes",
    Tipo == "B" ~ "No",
    Tipo == "V" ~ "No")
    )

# enframe shannon which is currently a vector
shannon_df <- enframe(shannon)

# need to change name to Sitio in shannon_df to match for left_join
# also change value to Shannon_Index
colnames(shannon_df) <- c("Sitio","Shannon_Index")

# join by "Sitio"
shannon_df <- left_join(site_type, shannon_df, by = "Sitio")
```

do the same thing for simpson_df
```{r}
simpson_df <- enframe(simpson)

colnames(simpson_df) <- c("Sitio","Simpson_Index")

simpson_df <- left_join(site_type, simpson_df, by = "Sitio")
```

and inverse simpson_df
```{r}
inv_simpson_df <- enframe(inv_simpson)

colnames(inv_simpson_df) <- c("Sitio","Inv_Simpson_Index")

inv_simpson_df <- left_join(site_type, inv_simpson_df, by = "Sitio")
```


--------------------------------------------------------------------------------
# run aovs across landuse types for each diversity index

none of these are significant currently, but shannon and simpson are close
- as more sequencing results come back it's possible this will become significant!
```{r}
shannon_aov <- aov(Shannon_Index ~ Tipo, data = shannon_df)
summary(shannon_aov)
# not sig - p = 0.14!

simpson_aov <- aov(Simpson_Index ~ Tipo, data = simpson_df)
summary(simpson_aov)
# not sig - p = 0.2!

inv_simpson_aov <- aov(Inv_Simpson_Index ~ Tipo, data = inv_simpson_df)
summary(inv_simpson_aov)
# not sig - p = 0.49!
```


--------------------------------------------------------------------------------
# plot how diversity indices vary across land types
- these are pretty much identical regardless of index used

shannon
```{r shannon diversity plot}
plot_shannon <- ggplot(shannon_df, 
                       aes(x = Tipo, y = Shannon_Index, fill = Tipo)) +
  geom_boxplot() +
  scale_fill_manual(values = pal) +
  scale_x_discrete(labels = c(site_labels)) +
  my_theme() +
  labs(x = "Landtype",
       y = "Shannon diversity",
       title = "Shannon diversity across landuse types")
plot_shannon
```

simpson
```{r simpson diversity plot}
plot_simpson <- ggplot(simpson_df, 
                       aes(x = Tipo, y = Simpson_Index, fill = Tipo)) +
  geom_boxplot() +
  scale_fill_manual(values = pal) +
  scale_x_discrete(labels = c(site_labels)) +
  my_theme() + 
  labs(x = "Landtype",
       y = "Simpson diversity",
       title = "Simpson diversity across landuse types")
plot_simpson
```

inv simpson
```{r inv simpson diversity plot}
plot_inv_simpson <- ggplot(inv_simpson_df, 
                           aes(x = Tipo, y = Inv_Simpson_Index, fill = Tipo)) +
  geom_boxplot() +
  scale_fill_manual(values = pal) +
  scale_x_discrete(labels = c(site_labels)) +
  my_theme() +
  labs(x = "Ecological landtype",
       y = "Inverse simpson diversity",
       title = "Inverse Simpson diversity across landuse types")
plot_inv_simpson
```


--------------------------------------------------------------------------------
# Compare diversity indices for harvested vs. unharvested sites

do the same thing as above, using harvested, unharvested column
- aovs across harvested, unharvested
```{r}
# shannon - sig
shannon_harvest_aov <- aov(Shannon_Index ~ harvested, data = shannon_df)
summary(shannon_harvest_aov)

# simpson - sig
simpson_harvest_aov <- aov(Simpson_Index ~ harvested, data = simpson_df)
summary(simpson_harvest_aov)

# inverse simpson - not sig
inv_simpson_harvest_aov <- aov(Inv_Simpson_Index ~ harvested, data = inv_simpson_df)
summary(inv_simpson_harvest_aov)
```

now make figures for each
## aesthetically think about fill colors

shannon_harvest
```{r}
plot_shannon_harvest <- ggplot(shannon_df, 
                               aes(x = harvested, y = Shannon_Index, 
                                   fill = harvested)) +
  geom_boxplot() +
  my_theme() +
  labs(x = "Harvested",
       y = "Shannon diversity",
       title = "Shannon diversity across harvested and unharvested sites")
plot_shannon_harvest
```

simpson_harvest
```{r}
plot_simpson_harvest <- ggplot(simpson_df, 
                               aes(x = harvested, y = Simpson_Index, 
                                   fill = harvested)) +
  geom_boxplot() +
  my_theme() +
  labs(x = "Harvested",
       y = "Simpson diversity",
       title = "Simpson diversity across harvested and unharvested sites")
plot_simpson_harvest
```

inv_simpson_harvest
```{r}
plot_inv_simpson_harvest <- ggplot(inv_simpson_df, 
                               aes(x = harvested, y = Inv_Simpson_Index, 
                                   fill = harvested)) +
  geom_boxplot() +
  my_theme() +
  labs(x = "Harvested",
       y = "Inverse Simpson diversity",
       title = "Inverse Simpson diversity across harvested and unharvested sites")
plot_inv_simpson_harvest
```


## AND RUN FALSE DISCOVERY RATE? A POST-HOC TEST NEEDED FOR DIVERSITY INDICES

--------------------------------------------------------------------------------
--------------------------------------------------------------------------------


# COMPOSITION ACROSS LANDUSE TYPES....


--------------------------------------------------------------------------------
# Pair-wise dissimilarity

Calculate pair-wise dissimilarity (distance) using vegdist
- gower and bray-curtis are good in detecting underlying ecological gradients
```{r}
par(mfrow = c(1, 2))
bray <- vegdist(new_mat, "bray") 
gower <- vegdist(new_mat, "gower")

hist(bray, xlim = range(0.0,1.0))
hist(gower, xlim = range(0.0,1.0))
```

## CONTINUE HERE
dissimilarity analysis is good way to explore variability in community comp
- next steps would be to do some sort of cluster analysis
- see where community associations exist
- but switching gears to look at rarefaction


--------------------------------------------------------------------------------
# Non-metric Multidimensional Scaling


## need to reorder new_mat rows to allow nmds to draw borders of communities
- goal is to represent info from multiple dimensions into a few, so can visualize
  and interpret.
- so here, present the similarity of communities in 2-dimensional space

this is going to be ugly, but have triple checked against original new_mat
```{r}
# Define the desired order of rows: Shade, Sun, Abandoned, Forest
new_order <- c(1,3,5,8,19,20,22,25,27,29,30,32, # shade (n=12)
               2,4,7,16,18,21,23,24,26,28,31, # sun (n=11)
               9,13,14,17, # abandoned (n=4)
               6,10,11,12,15 # forest (n=5)
               )

# Reorder rows
new_mat <- new_mat[new_order, ]
```


--------------------------------------------------------------------------------
## create NMDS plot and draw boundaries of landuse types

code from Peat Clark's vegan tutorial
```{r}
# use community by species matrix from above
new_mat_NMDS=metaMDS(new_mat, k=2)

plot(new_mat_NMDS)
# here sites are open circles, species are red crosses

# here help visualize by labeling specific sites and species

# ordination plot function especially for congested plots
ordiplot(new_mat_NMDS,type="n")
# this function adds text or points to ordination plots
orditorp(new_mat_NMDS,display="species",col="red",air=0.01)

orditorp(new_mat_NMDS,display="sites",cex=1.25,air=0.01)
```

## use ordihull to help visualize different treatments unifying sites

assign treatment levels per landuse type on reordered new_mat_reordered
```{r}
# ensure that labels are in correct order and have correct length
landuse_treatments=c(rep("Shade",12),
                     rep("Sun",11), 
                     rep("Abandoned",4), 
                     rep("Forest",5))

ordiplot(new_mat_NMDS,type="n")

ordihull(new_mat_NMDS,groups=landuse_treatments,draw="polygon",
         col="grey90",label=F)

orditorp(new_mat_NMDS,display="species",col="red",air=0.01)

# here colors need to align with landuse_treatments from above!
# of course need to use chocolate!
orditorp(new_mat_NMDS,display="sites",col=c(rep("chocolate4",12),
                                            rep("chocolate1",11),
                                            rep("lightgreen",4),
                                            rep("darkgreen",5)), 
         air=0.01,cex=1.25)
```

## very cool! see a lot of overlap in species simmilarity across landuse types
- but, forest and abandoned sites are similar, minus 3 outliers (FLL-B, FLL-C, FCAT-B3)
- these are also the lower elevation sites of the 9!
- think that elevation will be an important thing to include when comparing communities!
## CONTINUE HERE looking at elevation and group identity for NMDS

--------------------------------------------------------------------------------
--------------------------------------------------------------------------------


# RAREFACTION....This is more of a richness approach?


## COPIED FROM RANAS_EXPLORE _ REVIEW


technique to assess expected species richness
- allows calculation of species richness for given number of samples based on
  construction of rarefaction curves
  
issue is that the larger number of ind sampled, more species will be found
- rarefaction curves created by randomly re-sampling pool of N samples multiple
  times and then plotting average number of species found in each sample
- rarefaction generates expected number of species in small collection of n ind
  drawn from large pool of N samples
- typically grow rapidly at first, then slowly as only rarest species remain to
  be sampled

use rarefy and rarecurve functions
```{r}
spAbund <- rowSums(new_mat)
spAbund

test <- colSums(new_mat)
test
```



rarefaction uses smallest number of obs per sample to extrapolate expected
number if all other samples only had that number of obs
- VC-C only had 3!!! may want to proceed without this  in the future
- GP-N also only 9, without these two the next lowest is 22
```{r}
# including VC-C raremin is 3
raremin <- min(rowSums(new_mat))
raremin

sRare <- rarefy(new_mat, raremin)
sRare

# it won't allow us to override this to 22 (makes sense)
# so will need to remove VC-C, GP-N from sites, via row position
new_mat_abundant <- new_mat %>%
  filter(!row_number() %in% c(19, 31))

# let's see what happens with this as our raremin, and only using 30/32 sites
raremin_abundant <- min(rowSums(new_mat_abundant))
raremin_abundant

# sRare gives expected 'rarefied' number of species (not obs) if only 22 collected
sRare_abundant <- rarefy(new_mat_abundant, raremin_abundant)
sRare_abundant

shannon_aov <- aov(shannon ~ Tipo, data = site_type)
summary(shannon_aov)
```

## no statistical difference in rarefied species richness across types
*note that using rarefaction to remove effects of diff sample sizes is bad!*
```{r}
# join tipo data with sRare_abundant in a df
sRare_abundant_df <- sRare_abundant %>% 
  enframe() %>% 
  full_join(site_type, by = c("name" = "Sitio"))

sRare_abundant_aov <- aov(value ~ Tipo, data = sRare_abundant_df)
summary(sRare_abundant_aov)
# p-value is 0.183 (04/9/23) - check back in when sequencing is done!
```

visualization using rarecurve, for ggplot?
## make rarecurve for each type of site
## stuck!
```{r}
# rarecurve for each site, would be nice to have for each type!
rarecurve(new_mat_abundant, col = "blue", cex = 0.4)

# TEST - try to make separate curve for each type
# make dfs of equal length
#site_type_abundant <- site_type %>%
#                      filter(!Sitio == 'VC-C',
#                             !Sitio == 'GP-N')


# may need these as vector eventually?
#test <- cbind(new_mat_abundant, site_type_abundant)

#rarecurve_test <- rarecurve(test, step=1, label=TRUE, col = test$Tipo, 
#                            xlab = "Number of individuals sampled", ylab = "Species richness")
```




